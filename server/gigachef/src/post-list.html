<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="like-icon.html">

<dom-module id="post-list">
  <template>
    <style>
      :host {
        display: block;
        padding: 15px;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      paper-material {
        background: white;
        padding: 10px;
      }

      paper-material h1 {
        font-size: 1.25em;
        font-weight: 500;
      }

      strong {
        font-weight: 400;
      }

      .post-card {
        background: white;
        margin-bottom: 15px;
        width: 100%;
        font-weight: 300;
        border-radius: 2px;
        padding: 0;
      }

      .post-card-top-bar {
        padding: 16px;
        margin: 0;
      }

      .post-card-title {
        font-size: 16px;
        font-weight: 500;
        margin: 0;
      }

      .post-card-subtitle {
        font-size: 14px;
        font-weight: 300;
        margin: 0;
        color: var(--secondary-text-color);
      }

      .post-card-image {
        position: relative;
        width: 100%;
      }

      .post-card-earned-text {
        position: absolute; 
        bottom: 0;
        left: 0; 
        width: 100%;
      }

      .post-card-earned-text > * {
        background-color: rgba(0, 0, 0, 0.5);;
        color: white;
        padding: 16px;
      }

      .post-card-action-bar {
        padding: 8px;
      }

      .post-card-orders {
        padding: 0 8px;
        font-size: 14px;
        letter-spacing: .05em;
      }

      .post-card-order {
        padding: 8px;
        border-top: 1px solid #ececec;
      }

      .post-card-order-user {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .post-card-order-summary {
        padding-left: 16px;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .row {
        display: flex;
        flex-direction: row;
      }

      .column {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .flex-2 {
        flex: 2;
      }

      .center-text {
        text-align: center;
        justify-content: center;
      }

      .photo {
        display: block;
        width: 100%;
      	position: relative;
      	height: 0;
      	padding: 56.25% 0 0 0;
        overflow: hidden;
      }

      .photo img {
      	position: absolute;
        display: block;
        width: 100%;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        margin: auto;
      }

      .user-pic {
        height: 35px;
        width: 35px;
        border-radius: 50%;
        background-color: white;
        color: var(--secondary-text-color);
      }

      @media (min-width: 767px) {
        paper-material {
          flex-basis: 45%;
          max-width: 44%;
          margin: 1%;
        }
      }
    </style>

    <template is="dom-repeat" items="{{posts}}" as="post">
      <paper-material elevation="1" class="post-card">
        <div class="row post-card-top-bar">
          <div class="column">
            <h2 class="post-card-title">[[getPostTitle(post)]]</h2>
            <span class="post-card-subtitle">[[getCloseDatetime(post)]]</span>
          </div>
        </div>
        <div class="row">
          <div class="post-card-image">
            <div class="photo">
              <img src="[[getPhoto(post)]]"></img>
            </div>
            <div class="post-card-earned-text">
              <div>
                <strong>$[[getAmountEarned(post)]]</strong> earned from <strong>[[getNumOrders(post)]]</strong> servings
              </div>
            </div>
          </div>
        </div>
        <div class="row post-card-action-bar">
          <like-icon numlikes="[[post.num_likes]]"></like-icon>
        </div>
        <div class="post-card-orders">
        <template is="dom-repeat" items="[[post.orders]]" as="order" sort="sortByExchangeTime">
            <div class="row post-card-order">
                <div class="post-card-order-user">
                  <placeholder-img class="user-pic" icon="app:account-circle" src="[[order.gigamuncher_photo_url]]"></placeholder-img>
                  <span class="column center-text user-name">[[order.gigamuncher_name]]</span>
                </div>
              <div class="post-card-order-summary">
                <template is="dom-if" if$="[[isDelivery(order)]]">
                  <a href="[[getExchangeLink(order)]]" target="blank">[[getExchangeText(order)]]</a>
                </template>
                <template is="dom-if" if$="[[!isDelivery(order)]]">
                  <span>[[getExchangeText(order)]]</span>
                </template>
                <span>&nbsp;[[order.servings]] servings around [[getExchangeTime(order)]]</span>
              </div>
            </div>
          </template>
        </div>
      </paper-material>
    </template>

    <template is="dom-if" if="[[showTutorialCard]]">
      <paper-material>
        <h1>Tutorial Card</h1>
        <p>
          My Orders is where you can see the all your post and the number of servings each person ordered. 
          <br><br>
          Post a dish from <a href="/items">My Kitchen</a> to start building your brand and earn money cooking! :)
        </p>
      </paper-card>
    </template>

  </template>
  <script>
    'use strict';

    Polymer({
      is: 'post-list',

      properties: {
        posts: {
          type: Array,
          notify: true,
          reflectToAttribute: true,
          value: [],
        },
        service: {
          type: Object,
        },
        showTutorialCard: {
          type: Boolean,
          value: false,
        },
      },
      selected: function() {
        this.getPosts();
      },
      getPosts: function() {
        this.service.getPosts(0, 200, function (posts, err) {
          if (err.code !== 0) {
            this.fire('error', {
              error: err,
              options: [{
                text: 'Try Again',
                func: this.getItems.bind(this),
              }],
            });
          }
          if (posts === undefined || posts === null || posts.length < 2) {
            this.set('showTutorialCard', true);
          } else {
            this.set('showTutorialCard', false);
          }
          this.set('posts', posts);
        }.bind(this));
      },
      getPhoto: function(post) {
        if(post.photos === undefined || post.photos === null || post.photos[0] === '') {
          return '';
        }
        return post.photos[0];
      },
      getPostTitle: function(post) {
        if (post.title.length < 55) {
          return post.title;
        }
        return post.title.substring(0, 52) + '...';
        return 
      },
      getCloseDatetime: function(post) {
        var d = new Date(post.closing_datetime * 1000);
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString().replace(/:[0-9][0-9] /, ' ');
      },
      getAmountEarned: function(post) {
        var e = 0.0;
        if (post.orders !== undefined && post.orders !== null) {
          post.orders.forEach(
            function(order) {
              e += order.servings * post.chef_price_per_serving;
            }
          );
        }
        return e.toFixed(2);
      },
      getNumOrders: function(post) {
        var e = 0;
        if (post.orders !== undefined && post.orders !== null) {
          post.orders.forEach(
            function(order) {
              e += order.servings;
            }
          );
        }
        return e;
      },
      sortByExchangeTime: function(o1, o2) {
        if (o1.exchange_time === o2.exchange_time) {
          return o1.gigamuncher_name < o2.gigamuncher_name ? -1 : 1;
        }
        return o1.exchange_time < o2.exchange_time ? -1 : 1;
      },
      getExchangeTime: function(order) {
        return (new Date(order.exchange_time * 1000)).toLocaleTimeString().replace(/:[0-9][0-9] /, ' ');
      },
      getExchangeText: function(order) {
        if (order.exchange_method === 1) {
          return 'Pickup';
        } else {
          return 'Delivery';
        }
      },
      getExchangeLink: function(order) {
        if (order.exchange_method === 1) {
          return 'posts';
        } else {
          return 'http://maps.google.com/?q=' + encodeURIComponent(order.gigamuncher_address);
        }
      },
      isDelivery: function(order) {
        return order.exchange_method !== 1;
      },
    });
  </script>
</dom-module>
