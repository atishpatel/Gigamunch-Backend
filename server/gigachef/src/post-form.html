<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/app-route/app-route.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="datetime-input.html">
<link rel="import" href="item-fields.html">

<dom-module id="post-form">
  <template>
    <style>
      :host {
        display: block;
        padding: 15px;
        background-color: white;
        min-height: 86vh;
      }
      #submitButton {
        width: 100%;
        margin: 20px 0px;
      }

      #dialog {
        position: absolute;
        top: 64px;
        left: 0;
        right: 0;
        padding: 0;
        margin: 0;
        height: 95%;
        width: 100%;
        max-height: 100%;
        max-width: 100%;
        z-index: 1;
        box-shadow: none;
      }
    </style>

    <app-route
      route="{{route}}">
    </app-route>

    <form
      is="iron-form"
      id="form"
      method="post"
      action="#"
      on-change="updateSubmitButtonState">
      <item-fields
        id="itemFields"
        photos="{{post.photos}}"
        title="{{post.title}}"
        description="{{post.description}}"
        ingredients="{{post.ingredients}}"
        general-tags="{{post.general_tags}}"
        dietary-needs-tags="{{post.dietary_needs_tags}}">
      </item-fields>
      <paper-input
        label="Number of Servings Offered"
        value="{{post.servings_offered}}"
        type="number"
        required
        auto-validate>
      </paper-input>
      <paper-input
        label="Price per serving"
        value="{{post.chef_price_per_serving}}"
        type="number"
        required
        auto-validate>
        <div prefix>$&nbsp;</div>
      </paper-input>
      <datetime-input
        id="closeTime"
        label="Post close time"
        epoch="{{post.closing_datetime}}">
      </datetime-input>
      <template is="dom-if" if$="[[!post.is_order_now]]" restamp="true">
        <datetime-input
          id="readyTime"
          label="Meal ready time"
          epoch="{{post.ready_datetime}}">
        </datetime-input>
      </template>
      <paper-button
        id="submitButton"
        on-tap="submit"
        raised
        disabled>
        <paper-spinner id="spinner" hidden></paper-spinner>Save
      </paper-button>
    </form>

  </template>
  <script>
    'use strict';

    Polymer({
      is: 'post-form',

      properties: {
        post: {
          type: Object,
          notify: true,
          value: {},
        },
        item: {
          type: Object,
        },
      },
      selected: function () {
        this.$.spinner.hidden = true;
        this.$.spinner.active = false;
        if (this.route.path.substring(1) === '') {
          var d = {
            error: 'There is a problem with your URL. :( Please try to post an item again.',
            options: [{
              text: 'Go to items',
              func: function () {
                this.fire('redirect', { url: 'items' });
              }.bind(this)
            }],
          };
          this.fire('error', d);
          return;
        }
        if (this.item.id !== this.route.path.substring(1)) {
          this.getItem(this.route.path.substring(1));
        } else {
          this.setItem(this.item);
        }
      },
      setItem: function (item) {
        this.set('post', item);
        this.post.item_id = item.id;
        this.post.id = '';
        this.$.itemFields.update();
      },
      getItem: function (id) {
        if (id === undefined || id === '' || id === '0') {
          return;
        }
        if (this.item.id === id) {
          return;
        }
        this.service.getItem(id, function (item, err) {
          if (err.code !== 0) {
            var d = {
              error: err,
              options: [{
                text: 'Try Again',
                func: this.getItems
              }],
            };
            this.fire('error', d);
            return;
          }
          this.setItem(item);
        }.bind(this));
      },
      submit: function () {
        this.$.spinner.hidden = false;
        this.$.spinner.active = true;
        this.$.submitButton.disabled = true;
        this.post();
      },
      post: function() {
        this.service.postPost(this.post, function(post, err){
          if (err.code !== 0) {
            var d = {
              error: err,
              options: [{
                text: 'Try Again',
                func: this.post
              }],
            };
            this.fire('error', d);
            return;
          }
          this.fire('posted', { post: post });
        });
      },
      updateSubmitButtonState: function() {
        var form = this.$.form;
        var submitButton = this.$.submitButton;
        // Validate the entire form to see if we should enable the `Submit` button.
        submitButton.disabled = !form.validate();
      },
    });
  </script>
</dom-module>
