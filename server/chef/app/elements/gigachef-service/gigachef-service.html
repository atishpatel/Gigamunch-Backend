<!--
  gigachef-service is an element that connects to the Google Endpoint gigachefservice.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-apis/google-client-loader.html">

<dom-module id="gigachef-service">
  <template>
    <google-client-loader id="gigachefservice"
                          name="gigachefservice"
                          version="v1"
                          api-root="[[_getAPIRoot()]]"
                          on-google-api-load="_serviceLoaded"
                          ></google-client-loader>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'gigachef-service',

      properties: {
        user: {
          type: Object,
          notify: true
        },
        loaded: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: false
        },
        _callQueue: {
          type: Array,
          value: function() { return new Array() }
        }
      },
      getItem: function(id, callback) {
        // if api is not loaded, add to _callQueue
        if (!this.loaded) {
          this._callQueue.push(function() {
            this.getItem(id, callback);
          }.bind(this));
          return;
        }

        var request = {
          gigatoken: this._getGigatoken(),
          id: id,
        };
        this
          .service
          .getItem(request)
          .execute(
            function(resp) {
              this._logError(resp.err);
              callback(resp.item, resp.err);
            }.bind(this)
          );
      },
      getItems: function(startLimit, endLimit, callback) {
        // if api is not loaded, add to _callQueue
        if (!this.loaded) {
          this._callQueue.push(function() {
            this.getItems(startLimit, endLimit, callback);
          }.bind(this));
          return;
        }

        var request = {
          gigatoken: this._getGigatoken(),
          start_limit: startLimit,
          end_limit: endLimit,
        };
        this
          .service
          .getItems(request)
          .execute(
            function(resp) {
              this._logError(resp.err);
              callback(resp.items, resp.err);
            }.bind(this)
          );
      },
      saveItem: function(item, callback) {
        // if api is not loaded, add to _callQueue
        if (!this.loaded) {
          this._callQueue.push(function() {
            this.saveItem(item, callback);
          }.bind(this));
          return;
        }

        var request = {
          gigatoken: this._getGigatoken(),
          item: item,
        };

        this
          .service
          .saveItem(request)
          .execute(
            function(resp) {
              this._logError(resp.err);
              callback(resp.item, resp.err);
            }.bind(this)
          );
      },

      // getApplication gets the application for a user
      // callback paramerter should be function(application, error)
      getApplication: function(callback) {
        // if api is not loaded, add to _callQueue
        if (!this.loaded) {
          this._callQueue.push(function() {
            this.getApplication(callback);
          }.bind(this));
          return;
        }

        var request = {
          gigatoken: this._getGigatoken(),
        };
        this
          .service
          .getApplication(request)
          .execute(
            function(resp) {
              this._logError(resp.err);
              callback(resp.application, resp.err);
            }.bind(this)
          );
      },
      submitApplication: function(application, callback) {
        // if api is not loaded, add to _callQueue
        if (!this.loaded) {
          this._callQueue.push(function() {
            this.submitApplication(application, callback);
          }.bind(this));
          return;
        }

        var request = {
          gigatoken: this._getGigatoken(),
          application: application,
        };

        this
          .service
          .submitApplication(request)
          .execute(
            function(resp) {
              this._logError(err);
              callback(resp.application, resp.err);
            }.bind(this)
          );
      },
      _getGigatoken: function() {
        return this.user.token;
      },
      _logError: function(err) {
        if(err !== undefined) {
          if(err.code !== undefined && err.code !== 0) {
            // TODO: add google analytics logging
            console.log(err);
          }
        }
      },
      _serviceLoaded: function() {
        this.service = this.$.gigachefservice.api;
        this.loaded = true;
        // remove functions from _callQueue after calling them.
        if (this._callQueue !== undefined || this._callQueue !== null) {
          for (var i in this._callQueue) {
            this._callQueue[i]();
            delete(this._callQueue[i]);
          }
        }
      },

      _getAPIRoot: function() {
        var domain = window.location.host;
        if (domain.substring(0, 9) === 'localhost') {
          return 'http://localhost:8080/_ah/api';
        } else if (domain === 'gigamunch-omninexus-dev.appspot.com') {
          return 'https://endpoint-gigachef-dot-gigamunch-omninexus-dev.appspot.com/_ah/api';
        }
        return 'https://endpoint-gigachef-dot-gigamunch-omninexus.appspot.com/_ah/api';
      }

    });
  })();
  </script>
</dom-module>
