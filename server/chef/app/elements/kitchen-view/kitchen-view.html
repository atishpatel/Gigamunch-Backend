<!--
  `kitchen-view` is the view chefs go to to create, view, and edit Items.
  It uses the url to determine
  ### Variables:
    - route: route is used to navigate between the different subviews.
        '' is the list subview
        'view' is the detail view
        'edit' is the edit view.
  ### Events:
    - redirect: redirect event is fired when the page needs to be redirected.
                parameter: URL
    - toast: toast is fired when a toast message needs to be displayed.
             parameter: text
    - update-toolbar: update-toolbar is fired when the toolbar needs to be updated.
             parameter: title, subtitle, icon, iconCallback
  ### Public methods:
    - select(): select should be called when the view comes into focus.
      This functions does stuff like fetch the Item from URL parameters.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../item-list/item-list.html">
<link rel="import" href="../item-form/item-form.html">

<dom-module id="kitchen-view">
  <template>
    <style include="iron-flex iron-flex-alignment shared-styles">
      :host {
        display: block;
      }
    </style>

    <iron-pages attr-for-selected="data-route" selected="{{route}}">
      <section data-route="">
        <item-list id="list" items=[[_items]]></item-list>
        <paper-fab icon="add" on-tap="_addItem"></paper-fab>
      </section>
      <section data-route="view"></section>
      <section data-route="edit">
        <item-form id="edit" on-save="_saveItem" item={{_item}}></item-form>
      </section>
    </iron-pages>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'kitchen-view',

      properties: {
        route: {
          type: String,
          notify: true,
          value: ''
        },
        service: {
          type: Object,
          notify: true
        },
        _item: {
          type: Object,
          notify: true
        },
        _items: {
          type: Array,
          notify: true
        }
      },

      select: function() {
        // get id from url
        switch (this.route) {
          case '':
            this._getItems();
            break;
          case 'edit':
            // TODO get item from id
            break;
          default:
            // should never happen
            break;
        }
      },
      _getItems: function() {
        if (this.service === undefined) {
          this.async(this._getItems, 200);
          return;
        }
        var startLimit = 0;
        var endLimit = 100;
        this.service.getItems(startLimit, endLimit, function(items, err) {
            // TODO: handle err
            console.log('items', items, 'err', err);
            this._items = items;
         }.bind(this)
       );
      },
      _addItem: function() {
        this.fire('redirect', {URL: '/kitchen/edit'})
      },
      _saveItem: function() {
        if (this.service === undefined) {
          this.async(this._saveItem, 200);
          return;
        }

        this.service.saveItem(this._item, function(item, err) {
            // TODO: handle err
            console.log('save item err',err);
            this.$.edit.saved();
            this._item = item;
            var url = '/kitchen/view?id=' + item.id;
            this.fire('redirect', {URL: url});
         }.bind(this)
       );
      },
      _getParameterByName: function(name) {
        var url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)", "i"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }
    });
  })();
  </script>
</dom-module>
