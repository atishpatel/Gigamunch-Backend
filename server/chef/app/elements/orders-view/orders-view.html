<!--

-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../post-form/post-form.html">

<dom-module id="orders-view">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <iron-pages attr-for-selected="data-route" selected="{{route}}">
      <section data-route="">
      </section>
      <section data-route="view">
      </section>
      <section data-route="edit">
        <post-form id="edit"
                   on-post="_postPost"
                   item="[[_item]]"
                   type="[[_type]]">
        </post-form>
      </section>
    </iron-pages>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'orders-view',

      properties: {
        route: {
          type: String,
          notify: true,
          value: ''
        },
        service: {
          type: Object,
          notify: true
        },
        _item: {
          type: Object,
          notify: true
        },
        _post: {
          type: Object,
          notify: true
        },
        // 0 = preorder, 1 = order now
        _type: {
          type: Number,
          notify: true,
          value: 0
        }
      },
      select: function() {
        // get id from url
        switch (this.route) {
          case '':
            this._post = {};
            this._item = {};
            break;
          case 'edit':
            var id = this._getParameterByName('id');
            if(id !== ''){
              this._getItem(id);
            }
            var type = this._getParameterByName('type');
            if(type === 'orderNow'){
              this._type = 1;
            } else {
              this._type = 0;
            }
            break;
          default:
            // should never happen
            break;
        }
      },
      _getItem: function(id) {
        if (this.service === undefined) {
          this.async(function(){this._getItem(id)}.bind(this), 100);
          return;
        }
        this.service.getItem(id, function(item, err) {
            this._item = item;
         }.bind(this)
       );
      },
      _postPost: function(e) {
        if (this.service === undefined) {
          this.async(function() {
            this._postPost(e);
          }.bind(this), 200);
          return;
        }

        this.service.postPost(e.detail.post, function(post, err) {
            // TODO: handle err
            console.log('post post err',err);
            this.$.edit.saved();
            this._post = post;
            var url = '/orders/view?id=' + post.id;
            this.fire('redirect', {URL: url});
         }.bind(this));
      },
      _getParameterByName: function(name) {
        var url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)", "i"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }
    });
  })();
  </script>
</dom-module>
