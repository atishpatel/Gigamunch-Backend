function GetToken() {
  const name = 'GIGATKN=';
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) === 0) {
      return c.substring(name.length, c.length);
    }
  }
  if (location.hostname === 'localhost') {
    const tnk = window.localStorage.getItem('AUTHTKN');
    if (!tnk) {
      return '';
    }
    return tnk;
  }
  return '';
}

function SetToken(cvalue) {
  const jwt = GetJWT(cvalue);
  const d = new Date(0);
  d.setUTCSeconds(jwt.exp);
  document.cookie = `GIGATKN=${cvalue}; expires=${d.toUTCString()}; path=/`;
  if (location.hostname === 'localhost') {
    window.localStorage.setItem('GIGATKN', cvalue);
  }
}

function GetJWT(tkn) {
  const tknConv = tkn.replace(/[+\/]/g, (m0) => {
    return m0 === '+' ? '-' : '_';
  }).replace(/=/g, '');
  const userString = tknConv.split('.')[1].replace(/\s/g, '');
  return JSON.parse(window.atob(userString.replace(/[-_]/g, (m0) => {
    return m0 === '-' ? '+' : '/';
  }).replace(/[^A-Za-z0-9\+\/]/g, '')));
}


addEventListener('UserUpdated', UpdateUser);



function IsLoggedIn() {
  const tkn = GetToken();
  if (tkn === '') {
    return false;
  }
  return true;
}


function UpdateUser() {
  const jwt = GetJWT(GetToken());

}

UpdateUser();

const baseURL = '/api/v1/';

function Login(token) {
  const url = '/api/v1/Login';
  const req = {
    token,
  };
  return callFetch(url, 'POST', req).then((resp) => {
    if (resp && resp.token) {
      SetToken(resp.token);
    }
    return resp;
  });
}

function callFetch(url, method, body) {
  return fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/json',
      'auth-token': GetToken(),
    },
    body: JSON.stringify(body),
  }).then((resp) => {
    return resp.json();
  }).catch((err) => {
    console.error('failed to callFetch', err);
  });
}


console.log('app.js loaded');
