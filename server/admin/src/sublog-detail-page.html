<link rel="import"
      href="../../cook/bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../../cook/bower_components/google-map/google-map.html">
<link rel="import"
      href="../../cook/bower_components/google-map/google-map-marker.html">
<link rel="import"
      href="../../cook/src/shared-styles.html">

<link rel="import"
      href="sublog-sortable-table.html">

<dom-module id="sublog-detail-page">
  <template>
    <shared-styles>
      <style include="shared-styles">
         :host {
          display: block;
          padding: 10px;
        }

        .table-container {
          padding: 12px 0;
        }

        .table-title {
          font-size: 14px;
        }

        google-map {
          height: 600px;
        }

        .table {
          display: table;
          width: 100%;
          border: 1px solid #000;
        }

        .table-header-row {
          background-color: #ccc;
          display: table-header-group;
          font-weight: bold;
        }

        .table-row {
          display: table-row;
          width: auto;
          clear: both;
        }

        .table-cell {
          border: 1px solid #999999;
          padding: 3px 10px;
          display: table-cell;
          flex: 1;
          /*display: flex;*/
          justify-content: space-between;
          align-items: center;
        }

        .table-body {
          display: table-row-group;
        }

      </style>
    </shared-styles>

    <h1 class="">[[sublogsByDate.dateString]]</h1>
    <div class="table-container">
      <h2 class="table-title">
        Unskipped
      </h2>
      <sublog-sortable-table id="unskipped"
                             sublogs="[[sublogsByDate.unskippedSublogs]]">
      </sublog-sortable-table>
      <h2 class="table-title">
        Skipped
      </h2>
      <sublog-sortable-table id="skipped"
                             sublogs="[[sublogsByDate.skippedSublogs]]">
      </sublog-sortable-table>
      <h2>Delivery Tools</h2>
      <div>
        <div class="table">
          <div class="table-row table-header-row">
            <div class="table-cell">Driver</div>
            <div class="table-cell">Name</div>
            <div class="table-cell">Servings</div>
            <div class="table-cell">Veg Servings</div>
            <div class="table-cell">APT</div>
            <div class="table-cell">Address</div>
            <div class="table-cell">Phone Number</div>
            <div class="table-cell">Delivery Tip</div>
            <div class="table-cell">Delivery Time</div>
            <div class="table-cell">Status</div>
            <div class="table-cell">Email</div>
          </div>
          <dom-repeat items="[[sublogsByDate.unskippedSublogs]]"
                      as="sublog">
            <template>
              <div class="table-row">
                <div class="table-cell">[[sublog.driver]]</div>
                <div class="table-cell">[[sublog.name]]</div>
                <div class="table-cell">[[sublog.servings]]</div>
                <div class="table-cell">[[sublog.vegetarian_servings]]</div>
                <div class="table-cell">[[sublog.apt]]</div>
                <div class="table-cell">[[sublog.addressStr]]</div>
                <div class="table-cell">[[sublog.phone_number]]</div>
                <div class="table-cell">[[sublog.delivery_tips]]</div>
                <div class="table-cell">[[sublog.delivery_time]]</div>
                <div class="table-cell">[[sublog.status]]</div>
                <div class="table-cell">[[sublog.sub_email]]</div>
              </div>
            </template>
          </dom-repeat>
        </div>
        <br>
        <google-map id="map"
                    map="{{map}}"
                    fit-to-marker
                    disable-street-view-control
                    latitude="36.16"
                    longitude="-86.78"
                    api-key="[[apiKey]]">
          <dom-repeat items="[[sublogsByDate.unskippedSublogs]]"
                      as="sublog">
            <template>
              <google-map-marker label="[[sublog.name]]"
                                 latitude="[[sublog.address.latitude]]"
                                 longitude="[[sublog.address.longitude]]"
                                 draggable></google-map-marker>
            </template>
          </dom-repeat>

        </google-map>
      </div>
    </div>
  </template>

  <script>
    class SublogDetailPage extends Polymer.Element {
      static get is() {
        return 'sublog-detail-page';
      }

      static get properties() {
        return {
          service: {
            type: Object,
          },
          user: {
            type: Object,
            notify: true,
          },
          apiKey: {
            type: String,
            value: () => {
              return COOK.isProd ? 'AIzaSyApF3OWhumB5GeD20vQn_9NmToR0glkkOA' : 'AIzaSyAQOn9gsSWBu9nImfATaPKkSFp2I5MxbuU';
            },
          },
          sublogsByDate: {
            type: Array,
            notify: true,
          },
          polys: {
            type: Object,
          },
          map: {
            type: Object,
          },
        }
      }

      static get observers() {
        return [ /* observer descriptors */ ]
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();
      }

      selected() {
        const tmp = window.location.pathname.split('/sublogdetail/');
        const dateString = decodeURIComponent(tmp[1]);
        const d = new Date(dateString);
        this.getSubLogsForDate(d);
      }

      inside(point, vs) {
        // ray-casting algorithm based on
        // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html

        var x = point[0],
          y = point[1];

        var inside = false;
        for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
          var xi = vs[i][0],
            yi = vs[i][1];
          var xj = vs[j][0],
            yj = vs[j][1];

          var intersect = ((yi > y) != (yj > y)) &&
            (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }

        return inside;
      };

      setPolygons() {

        var shapes = [];
        var katherinePath = [
          new google.maps.LatLng(36.240950421445, -86.74942016601562),
          new google.maps.LatLng(36.19220033141526, -86.77482604980469),
          new google.maps.LatLng(36.16060736183511, -86.759033203125),
          new google.maps.LatLng(36.17945382412255, -86.69929504394531),
          new google.maps.LatLng(36.22101087439238, -86.71028137207031),
          new google.maps.LatLng(36.2354121683998, -86.7205810546875),
          new google.maps.LatLng(36.240950421445, -86.748046875)
        ];
        var polyline = new google.maps.Polyline({
          path: katherinePath,
          strokeColor: "#FF0000",
          strokeOpacity: .7,
          strokeWeight: 2
        });
        polyline.setMap(this.map);
        shapes.push(polyline);
        var piyushPath = [
          new google.maps.LatLng(36.32563675305861, -86.60316467285156),
          new google.maps.LatLng(36.30516547666426, -86.69586181640625),
          new google.maps.LatLng(36.23208902824811, -86.71165466308594),
          new google.maps.LatLng(36.17945382412255, -86.69174194335938),
          new google.maps.LatLng(36.130110843400146, -86.69174194335938),
          new google.maps.LatLng(36.14397436703243, -86.61003112792969),
          new google.maps.LatLng(36.16615090943873, -86.56333923339844),
          new google.maps.LatLng(36.24870331653197, -86.561279296875),
          new google.maps.LatLng(36.32508354600387, -86.60110473632812)
        ];
        var polyline = new google.maps.Polyline({
          path: piyushPath,
          strokeColor: "#00FF00",
          strokeOpacity: .7,
          strokeWeight: 2
        });
        polyline.setMap(this.map);
        shapes.push(polyline);
        var atishPath = [
          new google.maps.LatLng(36.086840909511004, -86.70272827148438),
          new google.maps.LatLng(36.07629718752892, -86.80778503417969),
          new google.maps.LatLng(35.915747419499695, -86.91009521484375),
          new google.maps.LatLng(35.884043325566886, -86.79130554199219),
          new google.maps.LatLng(35.89071892694686, -86.64710998535156),
          new google.maps.LatLng(35.94243575255426, -86.56951904296875),
          new google.maps.LatLng(35.97800618085566, -86.53793334960938),
          new google.maps.LatLng(36.00967260287175, -86.53175354003906),
          new google.maps.LatLng(36.041326309894316, -86.54205322265625),
          new google.maps.LatLng(36.072967297371555, -86.6217041015625),
          new google.maps.LatLng(36.08351146584746, -86.68899536132812),
          new google.maps.LatLng(36.08667546783092, -86.70437682733143)
        ];
        var polyline = new google.maps.Polyline({
          path: atishPath,
          strokeColor: "#0000FF",
          strokeOpacity: .7,
          strokeWeight: 2
        });
        polyline.setMap(this.map);
        shapes.push(polyline);
      }

      getDriver(latLng) {
        var katherinePath = [
          [36.240950421445, -86.74942016601562],
          [36.19220033141526, -86.77482604980469],
          [36.16060736183511, -86.759033203125],
          [36.17945382412255, -86.69929504394531],
          [36.22101087439238, -86.71028137207031],
          [36.2354121683998, -86.7205810546875],
          [36.240950421445, -86.748046875]
        ];
        if (this.inside(latLng, katherinePath)) {
          return 'Jackie';
        }
        var piyushPath = [
          [36.32563675305861, -86.60316467285156],
          [36.30516547666426, -86.69586181640625],
          [36.23208902824811, -86.71165466308594],
          [36.17945382412255, -86.69174194335938],
          [36.130110843400146, -86.69174194335938],
          [36.14397436703243, -86.61003112792969],
          [36.16615090943873, -86.56333923339844],
          [36.24870331653197, -86.561279296875],
          [36.32508354600387, -86.60110473632812]
        ];
        if (this.inside(latLng, piyushPath)) {
          return 'Piyush';
        }
        var atishPath = [
          [36.086840909511004, -86.70272827148438],
          [36.07629718752892, -86.80778503417969],
          [35.915747419499695, -86.91009521484375],
          [35.884043325566886, -86.79130554199219],
          [35.89071892694686, -86.64710998535156],
          [35.94243575255426, -86.56951904296875],
          [35.97800618085566, -86.53793334960938],
          [36.00967260287175, -86.53175354003906],
          [36.041326309894316, -86.54205322265625],
          [36.072967297371555, -86.6217041015625],
          [36.08351146584746, -86.68899536132812],
          [36.08667546783092, -86.70437682733143]
        ];
        if (this.inside(latLng, atishPath)) {
          return 'Atish';
        }
        var aliPath = [
          [36.17169406500341, -86.80503845214844],
          [36.146746777814364, -86.7974853515625],
          [36.11957292735451, -86.80366516113281],
          [36.09183481061278, -86.78787231445312],
          [36.08739580307919, -86.83387756347656],
          [36.10404078863735, -86.87370300292969],
          [36.13343831245866, -86.88812255859375],
          [36.15894422111004, -86.85859680175781],
          [36.16927640882672, -86.80430637156974]
        ];
        if (this.inside(latLng, aliPath)) {
          return 'Brea';
        }
        return '-';
      }

      getSubLogsForDate(d) {
        this.service.getSubLogsForDate(d, (slogs, err) => {
          if (err.code !== 0) {
            return;
          }
          let sublogDay = {
            date: slogs[0].date,
            dateString: this.getDateString(slogs[0].date),
            sublogs: [],
            skippedSublogs: [],
            unskippedSublogs: [],
          };
          for (let i = 0; i < slogs.length; i++) {
            sublogDay.sublogs.push(slogs[i]);
            if (slogs[i].skip || slogs[i].refunded) {
              sublogDay.skippedSublogs.push(slogs[i]);
            } else {
              slogs[i].apt = slogs[i].address.apt;

              function getAddress(a) {
                if (a && a.street) {
                  if (/\d/.test(a.street)) {
                    return a.street + ', ' + a.city;
                  }
                  let apt = '';
                  if (a.apt) {
                    apt = a.apt + ' ';
                  }
                  return apt + a.street + ', ' + a.city;
                }
                return '';
              }
              slogs[i].addressStr = getAddress(slogs[i].address);
              slogs[i].status = this.$.skipped.getStatus(slogs[i]);
              var latLng = [
                Number(slogs[i].address.latitude),
                Number(slogs[i].address.longitude),
              ];
              slogs[i].driver = this.getDriver(latLng);
              sublogDay.unskippedSublogs.push(slogs[i]);
            }
          }

          this.sublogsByDate = sublogDay;
        });
      }

      getDateString(dateString) {
        const d = new Date(dateString);
        return d.toUTCString().substring(0, 16);
      }

    }

    customElements.define(SublogDetailPage.is, SublogDetailPage);

  </script>
</dom-module>
