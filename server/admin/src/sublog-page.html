<!--<link rel="import" href="../bower_components/polymer/polymer.html">-->
<link rel="import"
      href="../../cook/src/shared-styles.html">

<link rel="import"
      href="sublog-table.html">

<dom-module id="sublog-page">
  <template>
    <shared-styles>
      <style include="shared-styles">
         :host {
          display: block;
          padding: 10px;
        }

        .table-container {
          padding: 12px 0;
        }

        .table-title {
          font-size: 14px;
        }

      </style>
    </shared-styles>

    <h1 class="">Sublogs</h1>
    <dom-repeat items="[[sublogsByDates]]">
      <template>
        <div class="table-container">
          <h2 class="table-date">
            <a href="sublogdetail/[[getDateLink(item.date)]]">
            [[getDateString(item.date)]]
            </a>
          </h2>
          <div class="table-title">
            Unskipped
          </div>
          <sublog-table class="table"
                        sublogs="[[item.unskippedSublogs]]">
          </sublog-table>
          <div class="table-title">
            Skipped
          </div>
          <sublog-table class="table"
                        sublogs="[[item.skippedSublogs]]">
          </sublog-table>

        </div>
      </template>
    </dom-repeat>
  </template>

  <script>
    class SublogPage extends Polymer.Element {
      static get is() {
        return 'sublog-page';
      }

      static get properties() {
        return {
          service: {
            type: Object,
          },
          user: {
            type: Object,
            notify: true,
          },
          sublogsByDates: {
            type: Array,
            notify: true,
          },
        }
      }

      static get observers() {
        return [ /* observer descriptors */ ]
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();
      }

      selected() {
        this.getSubLogs();
      }

      getSubLogs() {
        this.service.getSubLogs(function(slogs, err) {
          if (err.code !== 0) {
            return;
          }
          let sublogs = [];
          let sublogDay = {
            date: slogs[0].date,
            sublogs: [],
            skippedSublogs: [],
            unskippedSublogs: [],
          };
          for (let i = 0; i < slogs.length; i++) {
            if (sublogDay.date !== slogs[i].date) {
              sublogs.push(sublogDay);
              sublogDay = {
                date: slogs[i].date,
                sublogs: [],
                skippedSublogs: [],
                unskippedSublogs: [],
              };
            }

            sublogDay.sublogs.push(slogs[i]);
            if (slogs[i].skip) {
              sublogDay.skippedSublogs.push(slogs[i]);
            } else {
              sublogDay.unskippedSublogs.push(slogs[i]);
            }
          }
          this.sublogsByDates = sublogs;
        }.bind(this));
      }

      getDateString(dateString) {
        const d = new Date(dateString);
        return d.toUTCString().substring(0, 16);
      }

      getDateLink(dateString) {
        const d = new Date(dateString);
        return encodeURIComponent(d.toISOString().substr(0, 10))
      }
    }

    customElements.define(SublogPage.is, SublogPage);

  </script>
</dom-module>
