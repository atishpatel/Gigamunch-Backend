<link rel="import"
      href="../bower_components/polymer/polymer.html">
<link rel="import"
      href="../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import"
      href="../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">

<link rel="import"
      href="shared-styles.html">
<link rel="import"
      href="paper-select.html">
<link rel="import"
      href="select-with-options.html">

<dom-module id="work-schedule">
  <template>
    <style include="shared-styles paper-select">
       :host {
        display: block;
      }
      
      label {
        font-size: 12px;
        color: #727272;
        -webkit-font-smoothing: antialiased;
      }
      
      .input-header {
        font-size: 14px;
        padding: 8px 0;
        opacity: .7;
      }
      
      .week-days {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        padding-bottom: 12px;
      }
      
      .week-day {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      
      @media (max-width: 767px) {
        .week-day {
          flex-direction: column;
        }
      }

    </style>

    <div class="input-header">When do you work?</div>
    <div class="week-days">
      <template is="dom-repeat"
                items="[[weekDays]]"
                as="day"
                class="week-days">
        <div class="week-day">
          <paper-checkbox on-tap="updateSchedule"
                          checked="{{day.checked}}"></paper-checkbox>
          <span>[[day.name]]</span>
        </div>
      </template>
    </div>
    <div class="row">
      <div class="flex-1 column">
        <label>From</label>
        <paper-select id="startWorkTimeSelect"
                      invalid$="[[invalid]]">
          <select id="startWorkTime"
                  is="select-with-options"
                  option-value="value"
                  value="{{startWorkTime::change}}"
                  required>
          <option disabled selected value> -- select a time -- </option>
          <option value="06:00">06:00 AM</option>
          <option value="06:30">06:30 AM</option>
          <option value="07:00">07:00 AM</option>
          <option value="07:30">07:30 AM</option>
          <option value="08:00">08:00 AM</option>
          <option value="08:30">08:30 AM</option>
          <option value="09:00">09:00 AM</option>
          <option value="09:30">09:30 AM</option>
          <option value="10:00">10:00 AM</option>
          <option value="10:30">10:30 AM</option>
          <option value="11:00">11:00 AM</option>
          <option value="11:30">11:30 AM</option>
          <option value="12:00">12:00 PM (noon)</option>
          <option value="12:30">12:30 PM</option>
          <option value="13:00">01:00 PM</option>
          <option value="13:30">01:30 PM</option>
          <option value="14:00">02:00 PM</option>
          <option value="14:30">02:30 PM</option>
          <option value="15:00">03:00 PM</option>
          <option value="15:30">03:30 PM</option>
          <option value="16:00">04:00 PM</option>
          <option value="16:30">04:30 PM</option>
          <option value="17:00">05:00 PM</option>
          <option value="17:30">05:30 PM</option>
          <option value="18:00">06:00 PM</option>
          <option value="18:30">06:30 PM</option>
          <option value="19:00">07:00 PM</option>
          <option value="19:30">07:30 PM</option>
          <option value="20:00">08:00 PM</option>
          <option value="20:30">08:30 PM</option>
          <option value="21:00">09:00 PM</option>
          <option value="21:30">09:30 PM</option>
          <option value="22:00">10:00 PM</option>
          <option value="22:30">10:30 PM</option>
          <option value="23:00">11:00 PM</option>
          <option value="23:30">11:30 PM</option>
          <option value="00:00">12:00 AM (midnight)</option>
          <option value="00:30">12:30 AM</option>
          <option value="01:00">01:00 AM</option>
          <option value="01:30">01:30 AM</option>
          <option value="02:00">02:00 AM</option>
          <option value="02:30">02:30 AM</option>
          <option value="03:00">03:00 AM</option>
          <option value="03:30">03:30 AM</option>
          <option value="04:00">04:00 AM</option>
          <option value="04:30">04:30 AM</option>
          <option value="05:00">05:00 AM</option>
          <option value="05:30">05:30 AM</option>
        </select>
          <paper-md-decorator>
            <paper-underline></paper-underline>
          </paper-md-decorator>
        </paper-select>
      </div>
      <div class="flex-1 column">
        <label>To</label>
        <paper-select id="endWorkTimeSelect"
                      invalid$="[[invalid]]">
          <select id="endWorkTime"
                  is="select-with-options"
                  option-value="value"
                  value="{{endWorkTime::change}}"
                  required>
          <option disabled selected value> -- select a time -- </option>
          <option value="17:00">05:00 PM</option>
          <option value="17:30">05:30 PM</option>
          <option value="18:00">06:00 PM</option>
          <option value="18:30">06:30 PM</option>
          <option value="19:00">07:00 PM</option>
          <option value="19:30">07:30 PM</option>
          <option value="20:00">08:00 PM</option>
          <option value="20:30">08:30 PM</option>
          <option value="21:00">09:00 PM</option>
          <option value="21:30">09:30 PM</option>
          <option value="22:00">10:00 PM</option>
          <option value="22:30">10:30 PM</option>
          <option value="23:00">11:00 PM</option>
          <option value="23:30">11:30 PM</option>
          <option value="00:00">12:00 AM (midnight)</option>
          <option value="00:30">12:30 AM</option>
          <option value="01:00">01:00 AM</option>
          <option value="01:30">01:30 AM</option>
          <option value="02:00">02:00 AM</option>
          <option value="02:30">02:30 AM</option>
          <option value="03:00">03:00 AM</option>
          <option value="03:30">03:30 AM</option>
          <option value="04:00">04:00 AM</option>
          <option value="04:30">04:30 AM</option>
          <option value="05:00">05:00 AM</option>
          <option value="05:30">05:30 AM</option>
          <option value="06:00">06:00 AM</option>
          <option value="06:30">06:30 AM</option>
          <option value="07:00">07:00 AM</option>
          <option value="07:30">07:30 AM</option>
          <option value="08:00">08:00 AM</option>
          <option value="08:30">08:30 AM</option>
          <option value="09:00">09:00 AM</option>
          <option value="09:30">09:30 AM</option>
          <option value="10:00">10:00 AM</option>
          <option value="10:30">10:30 AM</option>
          <option value="11:00">11:00 AM</option>
          <option value="11:30">11:30 AM</option>
          <option value="12:00">12:00 PM (noon)</option>
          <option value="12:30">12:30 PM</option>
          <option value="13:00">01:00 PM</option>
          <option value="13:30">01:30 PM</option>
          <option value="14:00">02:00 PM</option>
          <option value="14:30">02:30 PM</option>
          <option value="15:00">03:00 PM</option>
          <option value="15:30">03:30 PM</option>
          <option value="16:00">04:00 PM</option>
          <option value="16:30">04:30 PM</option>
        </select>
          <paper-md-decorator>
            <paper-underline></paper-underline>
          </paper-md-decorator>
        </paper-select>
      </div>
    </div>

    <div class="input-header">What's your bed time?</div>
    <div class="column">
      <paper-select id="bedTimeSelect"
                    invalid$="[[invalid]]"
                    class="half-field">
        <select id="bedTime"
                is="select-with-options"
                option-value="value"
                value="{{bedTime::change}}"
                required>
        <option disabled selected value> -- select a time -- </option>
        <option value="18:00">06:00 PM</option>
        <option value="18:30">06:30 PM</option>
        <option value="19:00">07:00 PM</option>
        <option value="19:30">07:30 PM</option>
        <option value="20:00">08:00 PM</option>
        <option value="20:30">08:30 PM</option>
        <option value="21:00">09:00 PM</option>
        <option value="21:30">09:30 PM</option>
        <option value="22:00">10:00 PM</option>
        <option value="22:30">10:30 PM</option>
        <option value="23:00">11:00 PM</option>
        <option value="23:30">11:30 PM</option>
        <option value="00:00">12:00 AM (midnight)</option>
        <option value="00:30">12:30 AM</option>
        <option value="01:00">01:00 AM</option>
        <option value="01:30">01:30 AM</option>
        <option value="02:00">02:00 AM</option>
        <option value="02:30">02:30 AM</option>
        <option value="03:00">03:00 AM</option>
        <option value="04:00">04:00 AM</option>
        <option value="04:30">04:30 AM</option>
        <option value="05:00">05:00 AM</option>
        <option value="05:30">05:30 AM</option>
        <option value="06:00">06:00 AM</option>
        <option value="06:30">06:30 AM</option>
        <option value="07:00">07:00 AM</option>
        <option value="07:30">07:30 AM</option>
        <option value="08:00">08:00 AM</option>
        <option value="08:30">08:30 AM</option>
        <option value="09:00">09:00 AM</option>
        <option value="09:30">09:30 AM</option>
        <option value="10:00">10:00 AM</option>
        <option value="10:30">10:30 AM</option>
        <option value="11:00">11:00 AM</option>
        <option value="11:30">11:30 AM</option>
        <option value="12:00">12:00 PM (noon)</option>
        <option value="12:30">12:30 PM</option>
        <option value="13:00">01:00 PM</option>
        <option value="13:30">01:30 PM</option>
        <option value="14:00">02:00 PM</option>
        <option value="14:30">02:30 PM</option>
        <option value="15:00">03:00 PM</option>
        <option value="15:30">03:30 PM</option>
        <option value="16:00">04:00 PM</option>
        <option value="16:30">04:30 PM</option>
        <option value="17:00">05:00 PM</option>
        <option value="17:30">05:30 PM</option>
        </select>
        <paper-md-decorator>
          <paper-underline></paper-underline>
        </paper-md-decorator>
      </paper-select>
    </div>
  </template>
  <script>
    'use strict';

    Polymer({
      is: 'work-schedule',

      properties: {
        weekSchedule: {
          type: Array,
          notify: true,
          reflectToAttribute: true,
        },
        weekDays: {
          type: Array,
          notify: true,
          value: [{
            name: "Sun",
            checked: false,
          }, {
            name: "Mon",
            checked: true,
          }, {
            name: "Tue",
            checked: true,
          }, {
            name: "Wed",
            checked: true,
          }, {
            name: "Thur",
            checked: true,
          }, {
            name: "Fri",
            checked: true,
          }, {
            name: "Sat",
            checked: false,
          }, ],
        },
        startWorkTime: {
          type: String,
          value: '06:00',
          observer: 'updateSchedule',
        },
        endWorkTime: {
          type: String,
          value: '17:00',
          observer: 'updateSchedule',
        },
        bedTime: {
          type: String,
          value: '18:00',
          observer: 'updateSchedule',
        },
        invalid: {
          type: Boolean,
          value: false,
        }
      },
      behaviors: [
        Polymer.IronFormElementBehavior,
        Polymer.IronValidatableBehavior
      ],
      updateSchedule: function() {
        var newSchedule = [];
        var wakeupTime = new Date('1/1/2016 6:00');
        var bedTime = new Date('1/1/2016 ' + this.bedTime);
        var workStartTime = new Date('1/1/2016 ' + this.startWorkTime);
        var workEndTime = new Date('1/1/2016 ' + this.endWorkTime);

        if (bedTime < wakeupTime) { // bedTime is before wakeupTime
          var startTime = 0;
          // if their work ends after midnight 
          if (workEndTime < wakeupTime) {
            startTime = this.getSeconds(workEndTime);
            workEndTime = new Date('1/1/2016 23:59');
          }
          // if they don't sleep at midnight
          if (startTime !== 0) {
            var endTime = this.getSeconds(bedTime);
            // add availbility at early day if they sleep after 12 pm
            for (var i = 0; i < this.weekDays.length; i++) {
              newSchedule.push(this.newWeekScheduleObject(i, startTime, endTime - 1));
            }
          }
          bedTime = new Date('1/1/2016 23:59');
        }

        for (var i = 0; i < this.weekDays.length; i++) {
          if (this.weekDays[i].checked) {
            // add on a work day
            // add time between wakeup and starting work
            if (workStartTime > wakeupTime) {
              // add time between wakeup and starting work
              var startTime = this.getSeconds(wakeupTime);
              var endTime = startTime + Math.round(((workStartTime - wakeupTime) / 1000));
              newSchedule.push(this.newWeekScheduleObject(i, startTime, endTime - 1));
            }
            // add time after work ends to bed time
            if (workEndTime < bedTime) {
              // add time between end of work and bedTime
              var startTime = this.getSeconds(workEndTime);
              var endTime = startTime + Math.round(((bedTime - workEndTime) / 1000));
              newSchedule.push(this.newWeekScheduleObject(i, startTime, endTime - 1));
            }
          } else {
            // add on a non-work day
            var startTime = this.getSeconds(wakeupTime);
            var endTime = this.getSeconds(bedTime);
            newSchedule.push(this.newWeekScheduleObject(i, startTime, endTime - 1));
          }
        }
        this.weekSchedule = newSchedule;
        this._getValidity();
      },
      newWeekScheduleObject: function(day, startTime, endTime) {
        return {
          day_of_week: day,
          start_time: startTime,
          end_time: endTime,
        }
      },
      getSeconds: function(d) {
        return d.getHours() * 3600 + d.getMinutes() * 60;
      },
      _getValidity: function() {
        var valid = this.weekSchedule !== undefined && this.weekSchedule !== null && this.weekSchedule.length !== 0;
        this.invalid = !valid;
        return valid;
      },
    });

  </script>
</dom-module>
