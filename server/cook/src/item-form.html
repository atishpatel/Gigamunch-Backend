<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="file-input.html">
<link rel="import" href="app-icons.html">
<link rel="import" href="paper-collapse-item.html">

<dom-module id="item-form">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        background-color: white;
        color: var(--primary-text-color);
      }

      .header {
        font-size: 13px;
        margin: 11px 0;
      }

      .form {
          display: flex;
          flex-direction: column;
      }

      .half-field {
        width: 48.5%;
      }

      .submit-button {
          align-self: flex-end;
          width: 200px;
          margin: 32px 24px 0 0;
      }

      paper-input, paper-textarea {
        padding: 4px 0;
      }

      .add-image {
        text-align: center;
        border-style: dashed;
        border-color: black;
        cursor: pointer;
      }
      
      /* TODO Remove */
      .photo paper-icon-button {
        z-index: 1;
        position: absolute;
        top: 15px;
        right: 15px;
        --paper-icon-button: {
          background-color: gray;
          color: white;
          border-radius: 50%;
        }
      }

      paper-progress {
        width: 100%;
        padding: 10px 0;
      }

      .photoRequired {
        color: #dd2c00;
        white-space: normal;
      }

      @media (max-width: 767px) {
         .submit-button {
             width: 100%;
         } 
      }
    </style>

      <form
        is="iron-form"
        id="form"
        class="form"
        class="form"
        action="#"
        on-change="updateSubmitButtonState">
        <paper-collapse-item header="Item" opened>
            <template id="photos" is="dom-repeat" items="{{item.photos}}" as="photo">
                <div class="photo-16-9">
                    <paper-icon-button icon="app:close" on-tap="removePhoto"></paper-icon-button>
                    <img src="{{photo}}" alt="food photo"/>
                </div>
            </template>
            <p hidden$="[[!showPhotoRequired]]" class="photoRequired">*A photo is required. Note: Please, use your camera in <strong>landscape</strong> orientation because all photos will be cropped to a 16 x 9 ratio from the center.</p>
            <div id="progressBar" hidden><paper-progress value="[[progress]]"></paper-progress></div>
            <file-input id="fileInput"
                        photos="{{photos}}"
                        url-postfix="=s1080"
                        on-photoschanged="photosChanged"
                        on-progressstart="progressStart"
                        on-progressend="progressEnd"
                        progress="{{progress}}">
                <div class="add-image">
                    <paper-icon-button icon="app:add-a-photo"></paper-icon-button>
                    Add Image
                </div>
            </file-input>

            <paper-input label="Title*"
                        value="{{item.title}}"
                        placeholder="Pasta with sweet potato and goat cheese"
                        errorMessage="A title is required"
                        required
                        auto-validate>
            </paper-input>
            <paper-input>
            </paper-input>
            <paper-textarea label="Description*"
                        value="{{item.description}}"
                        placeholder="Fresh Pasta with sweet potato, goat cheese, roasted vegetables, and nutty almonds transform plain fettuccine noodles into a dinner worth craving!"
                        errorMessage="A description is required"
                        required
                        auto-validate>
            </paper-textarea>
            <paper-textarea label="Ingredients*"
                        placeholder="sweet potato, mushrooms, fettuccine noodles, almonds, goat cheese, salt, black pepper"
                        errorMessage="Ingredients are required"
                        value="{{_ingredients}}"
                        required
                        auto-validate>
            </paper-textarea>
            <!-- TODO: switch to a checklist for dietary needs -->
            <!--<paper-input label="Dietary Concerns Tags"
                        placeholder="dairy, nuts, meat"
                        value="{{_dietary_needs_tags}}"
                        auto-validate>
            </paper-input>-->

            <paper-input
                class="half-field"
                label="Price per serving*"
                value="{{item.cook_price_per_serving}}"
                type="number"
                step="0.01"
                min="0.50"
                required
                auto-validate>
            </paper-input>

        </paper-collapse-item>
        <paper-collapse-item header="Advanced">
            <div>
                <div>
                    <span class="header">Number of Servings</span>
                    <p >Set how many people you are willing to serve. Questions you should consider: Is it worth it for you to cook for 1 person, 2 people, etc.? Do you have supplies to present your food for a party?</p>
                </div>
                <paper-input
                    label="Min servings*"
                    value="{{item.min_servings}}"
                    type="number"
                    min="1"
                    required
                    auto-validate>
                </paper-input>
                <paper-input
                    label="Max servings*"
                    value="{{item.max_servings}}"
                    type="number"
                    min="4"
                    max="40"
                    required
                    auto-validate>
                </paper-input>
            </div>
        </paper-collapse-item>
        <paper-button
          id="submitButton"
          class="submit-button"
          on-tap="submit"
          raised
          disabled>
        <paper-spinner id="spinner" hidden></paper-spinner>Save Item
        </paper-button>
      </form>

  </template>
  <script>
    'use strict';

    Polymer({
      is: 'item-form',

      properties: {
        title: {
            type: String,
            notify: true,
            reflectToAttribute: true,
            value: 'Create Item',
        },
        submitText: {
            type: String,
            notify: true,
            value: 'Create Item',
        },
        item: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: {},
        },
        user: {
          type: Object,
        },
         _ingredients: {
          type: String,
          observer: '_updateIngredients',
        },
        showPhotoRequired: {
          type: Boolean,
          value: true,
        },
      },
      observers: [
        'itemPhotosChanged(item.photos)',
      ],

      selected: function () {
        this.deactivateSpinner();
        this.resetItem();
      },
      resetItem: function () {
          if (this.item === undefined) {
            this.item = {};
        }
        if (this.item.menu_id === undefined) {
            this.item.menu_id = '0';
        }
        if (this.item.min_servings === undefined) {
            this.set('item.min_servings', 1);
        }
        if (this.item.max_servings === undefined) {
            this.set('item.max_servings', 20);
        }
        if (this.item.id === undefined || this.item.id === '' || this.item.id === '0') {
            this.title = 'Create Item';
            this.submitText = 'Create Item';
            this.item.id = '0';
        } else {
            this.submitText = 'Update Item';
            this.title = 'Edit Item';
        }
      },
      submit: function () {
        this.activateSpinner();
        this.$.submitButton.disabled = true;
        this.saveItem();
      },
      saveItem: function() {
        this.activateSpinner();
        this.service.saveItem(this.item, function(item, err) {
          this.deactivateSpinner();
          if (err.code !== 0) {
            var d;
            if (err.code === 400) {
              d = {
                notification: true,
                error: err.message,
              };
            } else {
              d = {
                error: err,
              };
            }
            this.fire('error', d);
            return;
          }
          ga('send', 'event', 'item', 'created');
          this.fire('saved', { item: item });
        }.bind(this));
      },
      updateSubmitButtonState: function() {
        var form = this.$.form;
        var submitButton = this.$.submitButton;
        // Validate the entire form to see if we should enable the `Submit` button.
        var hasPhoto = this.item !== undefined && this.item.photos !== undefined && this.item.photos !== null && this.item.photos.length > 0;
        submitButton.disabled = !form.validate() || !hasPhoto;
      },
      itemPhotosChanged: function (p) {
        this.updateSubmitButtonState();
      },
      activateSpinner: function() {
        this.$.spinner.hidden = false;
        this.$.spinner.active = true;
      },
      deactivateSpinner: function() {
        this.$.spinner.hidden = true;
        this.$.spinner.active = false;
      },
      _updateIngredients: function(ing) {
        if (ing !== undefined && ing !== null) {
          this.ingredients = ing.split(/\s*,\s*/);
        }
      },
      removePhoto: function(e) {
        var index = this.photos.indexOf(e.model.photo);
        this.splice('photos', index, 1);
        this.photosUpdated(this.photos);
      },
      photosUpdated: function(photos) {
        if (photos === undefined || photos === null || photos.length === 0) {
          this.set('showPhotoRequired', true);
        } else {
          this.set('showPhotoRequired', false);
        }
      },
      photosChanged: function() {
        this.photosUpdated(this.item.photos);
        this.updateSubmitButtonState();
      },
      progressStart: function() {
        this.$.progressBar.hidden = false; 
      },
      progressEnd: function() {
        this.$.progressBar.hidden = true; 
      },
    });
  </script>
</dom-module>
