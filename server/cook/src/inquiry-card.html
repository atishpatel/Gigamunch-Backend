<link rel="import"
      href="../bower_components/polymer/polymer.html">
<link rel="import"
      href="../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import"
      href="../bower_components/iron-icon/iron-icon.html">

<link rel="import"
      href="placeholder-img.html">
<link rel="import"
      href="shared-styles.html">
<link rel="import"
      href="app-icons.html">


<dom-module id="inquiry-card">
  <template>
    <style include="shared-styles">
       :host {
        display: flex;
        flex-direction: column;
        border: solid var(--gray-line-color) 1px;
        border-radius: 10px;
        overflow: hidden;
        min-height: 275px;
      }
      
      iron-icon {
        color: var(--primary-text-color);
      }
      
      .bar {
        display: flex;
        align-items: center;
        padding: 12px;
      }
      
      .eater-bar {
        padding-bottom: 12px;
        border-bottom: solid var(--gray-line-color) 1px;
      }
      
      .eater-image {
        width: 48px;
        height: 48px;
        background-size: 48px;
        border-radius: 50%;
      }
      
      .eater-name-message {
        padding-left: 24px;
        display: flex;
        flex-direction: column;
      }
      
      .inquiry-status {
        margin-left: auto;
        display: flex;
        flex-direction: column;
        min-width: 70px;
        border-bottom-width: 2px;
        border-bottom-style: solid;
      }
      
      .inquiry-id {
        margin-left: 8px;
        display: flex;
        flex-direction: column;
      }
      
      @media (max-width: 400px) {
        .inquiry-id {
          display: none;
        }
      }
      
      .item-bar {
        height: 50px;
      }
      
      .item-image {
        width: 48px;
        border-radius: 5%;
        overflow: hidden;
      }
      
      .item-name {
        padding-left: 24px;
      }
      
      .time-servings-bar>*,
      .exchange-total-bar>* {
        flex: 1;
      }
      
      .icon-detail {
        display: flex;
        flex-direction: row;
      }
      
      .icon-detail-text {
        padding-left: 8px;
      }
      
      .button-bar>* {
        flex: 1;
        margin: 0;
        border-radius: 0;
      }
      
      .left-1px-margin {
        margin-left: 1px;
      }
      
      .button-bar {
        padding: 0;
        margin-top: 12px;
      }
      
      paper-button {
        margin: 0;
      }
      
      .spinner-container {
        min-height: 46px;
        display: flex;
        background-color: var(--primary-color);
      }
      
      .spinner-container>* {
        margin: auto;
      }

    </style>

    <div class="bar eater-bar">
      <template is="dom-if"
                if="[[showeater]]">
        <placeholder-img icon="app:account-circle"
                         class="eater-image"
                         src="[[inquiry.eater_photo_url]]">
        </placeholder-img>
        <div class="eater-name-message">
          <span class="eater-name">[[inquiry.eater_name]]</span>
          <div class="eater-message">
            <a href$="channel/[[messageURL]]">Message</a>
          </div>
        </div>
      </template>
      <div id="stateText"
           class="inquiry-status"
           style$="margin-right:[[stateRightMargin]];margin-left:[[stateLeftMargin]]">
        <span class="bold">Status:</span>
        <span>[[inquiryState]]</span>
      </div>
      <div class="inquiry-id">
        <span class="bold">ID:</span>
        <span>[[inquiryID]]</span>
      </div>
    </div>
    <div class="bar item-bar">
      <div class="item-image">
        <div class="photo-16-9">
          <img src="[[itemImage]]"></img>
        </div>
      </div>
      <span class="item-name bold">
          [[inquiry.item.name]]
      </span>
    </div>
    <div class="bar time-servings-bar">
      <div class="icon-detail">
        <iron-icon icon="app:insert-invitation"></iron-icon>
        <span class="icon-detail-text">[[exchangeDatetime]]</span>
      </div>
      <div class="icon-detail">
        <iron-icon icon="app:dining"></iron-icon>
        <span class="icon-detail-text">[[inquiryServingsText]]</span>
      </div>
    </div>
    <div class="bar exchange-total-bar">
      <div class="icon-detail">
        <iron-icon hidden$="[[deliveryIcon]]"
                   icon="app:home"></iron-icon>
        <iron-icon hidden$="[[!deliveryIcon]]"
                   icon="app:delivery-car"></iron-icon>
        <span class="icon-detail-text"
              hidden$="[[cookDelivery]]">[[exchangeText]]</span>
        <a href="[[cookDeliveryURL]]"
           hidden$="[[!cookDelivery]]">
          <span class="icon-detail-text">[[exchangeText]]</span>
        </a>
      </div>
      <div class="icon-detail">
        <iron-icon icon="app:money"></iron-icon>
        <span class="icon-detail-text">[[cookPriceWithDelivery]]</span>
      </div>
    </div>
    <div class="bar button-bar">
      <div hidden$="[[hideSpinner]]"
           class="spinner-container">
        <paper-spinner id="spinner"
                       active$="[[!hideSpinner]]"></paper-spinner>
      </div>
      <a href$="inquiry/[[inquiryID]]"
         class="row"
         hidden="[[hideDetailsButtons]]">
        <paper-button class="flex-1">Details</paper-button>
      </a>
      <paper-button class="left-1px-margin"
                    hidden="[[hideActionButtons]]"
                    on-tap="declineInquiry">Decline</paper-button>
      <paper-button class="left-1px-margin"
                    hidden="[[hideActionButtons]]"
                    on-tap="acceptInquiry">Accept</paper-button>
    </div>
  </template>

  <script>
    Polymer({
      is: 'inquiry-card',
      properties: {
        inquiry: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          observer: 'inquiryUpdated',
        },
        showeater: {
          type: Boolean,
          value: true,
          observer: 'showeaterUpdated'
        },
        itemImage: {
          type: String,
        },
        exchangeDatetime: {
          type: String,
        },
        inquiryID: {
          type: String,
        },
        inquiryState: {
          type: String,
        },
        inquiryServingsText: {
          type: String,
        },
        hideSpinner: {
          type: Boolean,
          value: true,
        },
        hideActionButtons: {
          type: Boolean,
          value: true,
        },
        hideDetailsButtons: {
          type: Boolean,
          value: false,
        },
        deliveryIcon: {
          type: Boolean,
          value: false,
        },
        cookDelivery: {
          type: Boolean,
          value: false,
        },
        cookDeliveryURL: {
          type: String,
          value: '',
        },
        exchangeText: {
          type: String,
          value: 'Pickup',
        },
        messageURL: {
          type: String,
        },
        stateRightMargin: {
          type: String,
        },
        stateLeftMargin: {
          type: String,
        },
        cookPriceWithDelivery: {
          type: Number,
        },
      },
      inquiryUpdated: function() {
        if (this.inquiry) {
          var inquiry = this.inquiry;
          var itemImage = "";
          if (this.inquiry.item.photos.length > 0) {
            itemImage = this.inquiry.item.photos[0];
          }
          this.set('itemImage', itemImage);
          // set exchangeDatetime 
          var today = new Date();
          var tomorrow = new Date();
          tomorrow.setDate(today.getDate() + 1);
          var d = new Date(inquiry.expected_exchange_datetime);
          if (inquiry.exchange_method !== 1 && inquiry.exchange_method !== 2) {
            d.setSeconds(d.getSeconds() - inquiry.exchange_plan_info.duration);
          }
          var dateStringArray = d.toDateString().split(' ');
          var dateString = dateStringArray[1] + ' ' + dateStringArray[2];
          if (dateStringArray[3] !== today.getFullYear().toString()) {
            dateString += ' ' + dateStringArray[3];
          }
          if (dateString === today.toLocaleDateString()) {
            dateString = 'Today';
          } else if (dateString === tomorrow.toLocaleDateString()) {
            dateString = 'Tomorrow';
          }
          var timeString = d.toLocaleTimeString().replace(/:[0-9][0-9] /, ' ');
          this.set('exchangeDatetime', dateString + ' ' + timeString);
          // set InquiryID 
          this.set('inquiryID', Number(inquiry.id).toString(36));
          var cookPriceWithDelivery = inquiry.payment_info.cook_price;
          // exchange info 
          if (inquiry.exchange_method === 1) {
            // pickup
            this.cookDelivery = false;
            this.deliveryIcon = false;
            this.exchangeText = 'Pickup';
          } else if (inquiry.exchange_method === 2) {
            // cook delivery
            this.cookDelivery = true;
            this.deliveryIcon = true;
            this.exchangeText = 'Delivery';
            cookPriceWithDelivery += inquiry.payment_info.exchange_price;
            this.eaterAddressMapsURL = this.getAddressMapsURL(inquiry.exchange_plan_info.eater_address);
          } else {
            // 3rd party delivery
            this.cookDelivery = false;
            this.deliveryIcon = true;
            if (inquiry.exchange_method === 4) {
              this.exchangeText = 'Gigamunch Delivery';
            } else {
              this.exchangeText = '3rd Party Delivery';
            }
          }
          this.cookPriceWithDelivery = cookPriceWithDelivery;
          this.updateActionButtonStates();
          this.messageURL = encodeURIComponent(inquiry.cook_id + '<;>' + inquiry.eater_id);

          if (inquiry.servings === 1) {
            this.inquiryServingsText = inquiry.servings.toString() + ' serving';
          } else {
            this.inquiryServingsText = inquiry.servings.toString() + ' servings';
          }

          var red = '#FD5C63';
          var yellow = '#FFEB3B';
          var green = '#57C45B';
          var gray = '#78909C';
          var color = '#78909C';
          var inquiryStateString = inquiry.state;
          switch (inquiry.state) {
            case 'Pending':
              color = yellow;
              break;
            case 'Accepted':
              color = green;
              break;
            case 'Declined':
              color = red;
              break;
            case 'Fulfilled':
              color = green;
              break;
            case 'RefunedRequested':
              inquiryStateString = 'Refuned Requested';
              color = yellow;
              break;
            case 'Refunded':
              color = green;
              break;
            case 'Canceled':
              color = gray;
              break;
            case 'TimedOut':
              inquiryStateString = 'Timed out';
              color = red;
              break;
            default:
              color = gray;
          }
          this.inquiryState = inquiryStateString;
          this.$.stateText.style.borderBottomColor = color;
        }
      },
      acceptInquiry: function() {
        this.hideSpinner = false;
        this.hideActionButtons = true;
        this.hideDetailsButtons = true;
        this.fire('acceptinquiry', {
          id: this.inquiry.id,
          callback: this.updateInquiry.bind(this),
        });
      },
      declineInquiry: function() {
        this.hideSpinner = false;
        this.hideActionButtons = true;
        this.hideDetailsButtons = true;
        this.fire('declineinquiry', {
          id: this.inquiry.id,
          callback: this.updateInquiry.bind(this),
        });
      },
      updateInquiry: function(inquiry, err) {
        if (err) {
          if (err.code !== 0) {
            this.fire('error', err);
            return;
          }
        }
        this.inquiry = inquiry;
      },
      updateActionButtonStates: function() {
        this.hideSpinner = true;
        this.hideDetailsButtons = false;
        if (this.inquiry && this.inquiry.state === 'Pending') {
          this.hideActionButtons = false;
        } else {
          this.hideActionButtons = true;
        }
      },
      showeaterUpdated: function() {
        if (!this.showeater) {
          this.stateRightMargin = 'auto';
          this.stateLeftMargin = '0';
        } else {
          this.stateRightMargin = '0';
          this.stateLeftMargin = 'auto';
        }
      },
      getAddressMapsURL: function(a) {
        if (a) {
          return 'https://maps.google.com/?q=' + encodeURIComponent(a.street + ', ' + a.city + ', ' + a.state + ' ' + a.zip);
        }
        return '';
      },
    });

  </script>
</dom-module>
