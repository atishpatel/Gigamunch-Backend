<link rel="import"
      href="../bower_components/polymer/polymer.html">
<link rel="import"
      href="shared-styles.html">
<link rel="import"
      href="placeholder-img.html">

<dom-module id="channel-card">
  <template>
    <style include="shared-styles">
       :host {
        display: flex;
        flex-direction: row;
        border-bottom: solid var(--gray-line-color) 1px;
      }
      
      .row {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
      }
      
      .column {
        display: flex;
        flex-direction: column;
      }
      
      a,
      a:link,
      a:visited {
        color: var(--primary-text-color);
      }
      
      .channel-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        padding: 12px 24px;
      }
      
      .user-pic {
        height: 35px;
        width: 35px;
        background-size: 35px;
        border-radius: 50%;
      }
      
      .eater-name {
        font-size: 16px;
        line-height: 16px;
      }
      
      .last-message {
        font-size: 12px;
      }
      
      .divider-line {
        margin: 6px 0;
        width: 43px;
        height: 1px;
        background-color: var(--gray-line-color);
      }
      
      .item-image {
        width: 35px;
        border-radius: 5%;
        overflow: hidden;
      }
      
      .item-name {
        font-size: 16px;
        line-height: 16px;
      }
      
      .inquiry-state {
        font-size: 12px;
        min-width: 55px;
      }
      
      .inquiry-state-icon {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin: auto;
      }

    </style>
    <a class="channel-container"
       href$="channel/[[channelEncodedName]]">
      <div class="row message-container">
        <div>
          <placeholder-img class="user-pic"
                           icon="app:account-circle"
                           alt="user profile picture"
                           src="[[eaterImage]]"></placeholder-img>
        </div>
        <div class="column">
          <div class="eater-name">[[eaterName]]</div>
          <div class="last-message secondary-text">[[lastMessage]]</div>
        </div>
      </div>
      <div class="divider-line"></div>
      <div class="row inquiry-container">
        <div class="item-image">
          <div class="photo-16-9">
            <img src="[[itemImage]]"></img>
          </div>
        </div>
        <div class="column">
          <div class="item-name">[[itemName]]</div>
          <div class="row">
            <span class="inquiry-state secondary-text">[[inquiryState]]</span>
            <div style$="background-color:[[inquiryStateIconColor]]"
                 class="inquiry-state-icon"></div>
          </div>
        </div>
      </div>
    </a>

  </template>

  <script>
    Polymer({
      is: 'channel-card',
      properties: {
        channel: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          observer: 'channelUpdated',
        },
        eaterImage: {
          type: String,
        },
        eaterName: {
          type: String,
        },
        inquiryState: {
          type: String,
        },
        inquiryStateIconColor: {
          type: String,
          value: 'white',
        },
        itemName: {
          type: String,
        },
        itemImage: {
          type: String,
        },
        channelEncodedName: {
          type: String,
        },
        lastMessage: {
          type: String,
        },
      },
      channelUpdated: function() {
        if (this.channel) {
          this.channelEncodedName = encodeURIComponent(this.channel.uniqueName);
          this.channel.getAttributes().then(function(attr) {
            this.eaterImage = attr.eater_image;
            this.itemImage = attr.item_image;
            this.eaterName = attr.eater_name;
            this.itemName = attr.item_name;
            var red = '#FD5C63';
            var yellow = '#FFEB3B';
            var green = '#57C45B';
            var gray = '#78909C';
            var color = 'white';
            var inquiryStateString = attr.inquiry_state;
            switch (attr.inquiry_state) {
              case 'Pending':
                color = yellow;
                break;
              case 'Accepted':
                color = green;
                break;
              case 'Declined':
                color = red;
                break;
              case 'Fulfilled':
                color = green;
                break;
              case 'RefunedRequested':
                inquiryStateString = 'Refuned Requested';
                color = yellow;
                break;
              case 'Refunded':
                color = green;
                break;
              case 'Canceled':
                color = gray;
                break;
              case 'TimedOut':
                inquiryStateString = 'Timed out';
                color = red;
                break;
              default:
                color = gray;
            }
            this.inquiryState = inquiryStateString;
            this.inquiryStateIconColor = color;

          }.bind(this))
          this.channel.getMessages(10).then(function(messages) {
            for (var i = messages.length - 1; i >= 0; i--) {
              if (!messages[i].author.includes('Bot')) {
                var body = messages[i].body;
                if (body) {
                  if (body.length > 45) {
                    this.lastMessage = body.substr(0, 45) + '...';
                  } else {
                    this.lastMessage = body;
                  }
                }
                break;
              }
            }
          }.bind(this))
        }
      },
    });

  </script>
</dom-module>
