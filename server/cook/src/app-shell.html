<link rel="import"
      href="../bower_components/polymer/polymer.html">
<link rel="import"
      href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import"
      href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import"
      href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import"
      href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import"
      href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import"
      href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import"
      href="../bower_components/app-route/app-location.html">
<link rel="import"
      href="../bower_components/app-route/app-route.html">
<link rel="import"
      href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import"
      href="../bower_components/iron-pages/iron-pages.html">
<link rel="import"
      href="../bower_components/iron-selector/iron-selector.html">
<link rel="import"
      href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import"
      href="../bower_components/paper-item/paper-item.html">
<link rel="import"
      href="../bower_components/paper-menu/paper-menu.html">
<link rel="import"
      href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import"
      href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import"
      href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import"
      href="../bower_components/paper-toast/paper-toast.html">


<!--<link rel="import"
      href="app-footer.html">-->
<link rel="import"
      href="app-icons.html">
<link rel="import"
      href="item-form.html">
<link rel="import"
      href="placeholder-img.html">
<link rel="import"
      href="shared-styles.html">

<dom-module id="app-shell">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        color: var(--primary-text-color);
        --paper-tabs-selection-bar-color: #546E7A;
        --paper-tab-ink: #546E7A;
      }
      
      .content {
        max-width: var(--max-content-width);
        margin: auto;
      }
      
      app-header {
        color: var(--primary-text-color);
        background-color: #fff;
      }
      
      app-header .logo {
        color: var(--primary-color);
      }
      
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      
      .page-header-title {
        @apply(--font-bold);
        font-size: 24px;
      }
      
      .toolbar-right {
        display: flex;
        flex-direction: row;
        height: 100%;
      }
      
      .nav-a,
      .nav-a:link,
      .nav-a:visited {
        text-decoration: none;
        outline: 0;
        color: #546E7A;
      }
      
      .nav-tabs {
        height: 100%;
        margin-right: 12px;
        font-size: 16px;
      }
      
      .nav-tabs a {
        padding: 0 15px;
        text-decoration: none;
        outline: 0;
        color: #546E7A;
      }
      
      .user-pic {
        height: 30px;
        width: 30px;
        border-radius: 50%;
        background-color: white;
        color: var(--secondary-text-color);
      }
      
      .main-toolbar {
        padding: 0 24px;
      }
      
      .drawer-toolbar {
        height: 100px;
        justify-content: space-around;
        align-items: flex-start;
        flex-direction: column;
        background-color: var(--primary-color);
        color: white;
      }
      
      .drawer-user-info {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      
      .drawer-user-info .user-pic {
        margin-right: 12px;
      }
      
      .drawer-user-name {
        font-size: 16px;
      }
      
      .drawer-user-email {
        font-size: 12px;
      }
      
      .drawer-list {
        padding-top: 8px;
      }
      
      .drawer-list paper-item {
        font-size: 16px;
        outline: none;
      }
      
      .drawer-list a {
        display: block;
        text-decoration: none;
        color: var(--link-color);
        line-height: 40px;
        outline: none;
      }
      
      .drawer-list a.iron-selected {
        color: #5d686d;
        background-color: #ECEFF1;
        font-weight: bold;
      }
      
      .drawer-stuff {
        display: none;
      }
      
      @media (max-width: 767px) {
        .nav-tabs-stuff {
          display: none;
        }
        .drawer-stuff {
          display: initial;
        }
      }
      
      .full-screen-dialog {
        position: fixed;
        overflow-x: hidden;
        top: 0;
        left: 0;
        z-index: 100;
        margin: 0;
        width: 100%;
        height: 100%;
      }
      
      .full-screen-dialog>paper-dialog-scrollable {
        padding: 0;
      }
      
      .full-screen-dialog-close-icon {
        margin: 16px 0 0 16px;
      }
      
      .full-screen-dialog-content {
        padding: 24px;
      }
      
      #errorDialogDetails {
        color: var(--secondary-text-color);
      }
      
      #notificationDialog paper-button,
      #errorDialog paper-button {
        color: var(--primary-color);
        background-color: white;
      }
      
      #notificationDialog .buttons,
      #errorDialog .buttons {
        margin-top: 20px;
        min-width: 300px;
      }

    </style>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}"
               pattern="[[baseurl]]/:page"
               data="{{routeData}}"
               tail="{{subroute}}">
    </app-route>
    <iron-media-query query="max-width: 767px"
                      query-matches="{{smallScreen}}">
    </iron-media-query>
    <paper-dialog id="notificationDialog"
                  modal>
      <div id="notificationDialogText"></div>
      <div class="buttons">
        <paper-button dialog-dismiss>OK</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="errorDialog"
                  modal>
      <h1 id="errorDialogTitle">Woops! Something went wrong! :(</h1>
      <div>We're sorry for the inconvenience. Refresh the page and try again in a few minutes. If the issue persist, please send a screen shot of this to atish@gigamunchapp.com. Our developer, Atish, will work on fixing it ASAP! </div>
      <div id="errorDialogText"></div>
      <div id="errorDialogDetails"></div>
      <div class="buttons">
        <paper-button dialog-dismiss>OK</paper-button>
      </div>
    </paper-dialog>
    <paper-toast id="toast"></paper-toast>
    <paper-dialog id="itemDialog"
                  class="full-screen-dialog">
      <paper-dialog-scrollable>
        <div>
          <paper-icon-button class="full-screen-dialog-close-icon"
                             icon="app:close"
                             dialog-dismiss></paper-icon-button>
          <span class="toolbar-title">[[itemFormTitle]]</span>
        </div>
        <item-form id="itemForm"
                   class="full-screen-dialog-content content"
                   service="[[service]]"
                   title="{{itemFormTitle}}"
                   item="{{item}}"
                   on-saved="itemSaved">
        </item-form>
      </paper-dialog-scrollable>
    </paper-dialog>

    <app-drawer-layout fullbleed
                       force-narrow>
      <!-- Drawer content -->
      <app-drawer class="drawer-stuff">
        <app-toolbar class="drawer-toolbar">
          <div class="logo">Gigamunch</div>
          <div class="drawer-user-info">
            <placeholder-img class="user-pic"
                             icon="app:account-circle"
                             alt="user profile picture"
                             src="[[user.photo_url]]"></placeholder-img>
            <div class="drawer-user-text">
              <!-- TODO set ... on name and email -->
              <div class="drawer-user-name"><strong>[[user.name]]</strong></div>
              <div class="drawer-user-email">[[user.email]]</div>
            </div>
          </div>
        </app-toolbar>
        <iron-selector selected="[[page]]"
                       attr-for-selected="name"
                       class="drawer-list"
                       role="navigation">
          <a name="kitchen"
             href="../kitchen">
            <paper-item>Kitchen</paper-item>
          </a>
          <a name="account"
             href="../account">
            <paper-item>Account</paper-item>
          </a>
          <a href="/signout">
            <paper-item>Log out</paper-item>
          </a>
        </iron-selector>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>
        <app-header condenses
                    reveals
                    effects="waterfall">
          <app-toolbar class="content main-toolbar">
            <paper-icon-button class="drawer-stuff"
                               icon="app:menu"
                               drawer-toggle>
            </paper-icon-button>
            <div main-title>
              <div hidden$="[[hideHeaderLogo]]"
                   class="logo">Gigamunch</div>
              <div hidden$="[[!hideHeaderLogo]]"
                   class="page-header">
                <span class="page-header-title">[[title]]</span>
              </div>
            </div>
            <div class="toolbar-right nav-tabs-stuff">
              <paper-tabs class="nav-tabs vertical-align-center"
                          attr-for-selected="name"
                          selected="{{page}}">
                <paper-tab name="kitchen">
                  <a class="nav-a vertical-align-center"
                     href="../kitchen"><span>Kitchen</span></a>
                </paper-tab>
                <paper-tab name="account">
                  <a class="nav-a vertical-align-center"
                     href="../account"><span>Account</span></a>
                </paper-tab>
              </paper-tabs>
              <a class="vertical-align-center"
                 href="../account">
                <placeholder-img class="user-pic"
                                 icon="app:account-circle"
                                 alt="user profile picture"
                                 src="[[user.photo_url]]"></placeholder-img>
              </a>
              <paper-menu-button horizontal-align="right"
                                 vertical-offset="15"
                                 class="vertical-align-center">
                <paper-icon-button icon="app:more-vert"
                                   class="dropdown-trigger"
                                   alt="bottom align"></paper-icon-button>
                <paper-menu class="dropdown-content">
                  <a class="nav-a"
                     href="../account">
                    <paper-item class="bold">Account</paper-item>
                  </a>
                  <a class="nav-a"
                     href="/signout">
                    <paper-item class="bold">Log out</paper-item>
                  </a>
                </paper-menu>
              </paper-menu-button>
            </div>
          </app-toolbar>
        </app-header>

        <iron-pages selected="[[page]]"
                    attr-for-selected="name"
                    fallback-selection="view404"
                    role="main">
          <kitchen-page id="kitchen"
                        name="kitchen"
                        service="[[service]]"
                        user="{{user}}">
          </kitchen-page>
          <inquiries-page id="inquiries"
                          name="inquiries"
                          service="[[service]]"
                          user="{{user}}">
          </inquiries-page>
          <messages-page id="messages"
                         name="messages"
                         service="[[service]]"
                         user="{{user}}">
          </messages-page>
          <onboard-steps id="onboard"
                         name="onboard"
                         smallScreen="[[smallScreen]]"
                         service="[[service]]"
                         user="{{user}}">
          </onboard-steps>
          <account-page id="account"
                        name="account"
                        service="[[service]]"
                        user="{{user}}">
          </account-page>
          <my-view404 name="view404"></my-view404>
        </iron-pages>
        <!--<app-footer></app-footer>-->
      </app-header-layout>
    </app-drawer-layout>
  </template>
  <script>
    Polymer({
      is: 'app-shell',

      properties: {
        title: {
          type: String,
          observer: 'titleUpdated',
        },
        baseurl: {
          type: String,
        },
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },
        route: {
          type: Object,
          notify: true,
        },
        subroute: {
          type: Object,
          notify: true,
        },
        item: {
          type: Object,
          notify: true,
        },
        service: {
          type: Object,
          value: function() {
            return COOK.Service;
          }
        },
        user: {
          type: Object,
          notify: true,
          value: function() {
            return COOK.User;
          }
        },
        hideHeaderLogo: {
          type: Boolean,
          value: true,
        },
      },

      observers: [
        '_routePageChanged(routeData.page)',
        '_routePathChanged(route.path)',
        '_pageOrScreenChanged(page, smallScreen)',
      ],
      listeners: {
        'acceptinquiry': 'acceptInquiry',
        'declineinquiry': 'declineInquiry',
        'savemenu': 'saveMenu',
        'editmenuitem': 'addMenuItem',
        'activateitem': 'activateItem',
        'deactivateitem': 'deactivateItem',
        'onboardfinished': 'onboardFinished',
        'toast': 'toastEvent',
        'error': 'errorEvent',
      },
      acceptInquiry: function(e, detail) {
        var inquiryID = detail.id;
        var callback = detail.callback;
        this.service.acceptInquiry(inquiryID, callback);
      },
      declineInquiry: function(e, detail) {
        var inquiryID = detail.id;
        var callback = detail.callback;
        this.service.declineInquiry(inquiryID, callback);
      },
      activateItem: function(e, detail) {
        var itemID = detail.id;
        var callback = detail.callback;
        this.service.activateItem(itemID, callback);
      },
      deactivateItem: function(e, detail) {
        var itemID = detail.id;
        var callback = detail.callback;
        this.service.deactivateItem(itemID, callback);
      },
      onboardFinished: function() {
        this.setPath('kitchen');
      },
      addMenuItem: function(e) {
        this.set('item', e.detail.item);
        this.openItemForm();
      },
      saveMenu: function(e, menu) {
        delete menu.items;
        if (menu.id === undefined || menu.id === null || menu.id === '' || menu.id === '0') {
          this.openItemForm();
        }
        this.service.saveMenu(menu, function(menu, err) {
          if (err.code !== 0) {
            this.fire('error', err)
            return;
          }
          this.set('item.menu_id', menu.id);
        }.bind(this));
      },
      openItemForm: function() {
        this.$.itemDialog.open();
        this.$.itemForm.selected();
      },
      itemSaved: function() {
        this.$.itemDialog.close();
      },
      ready: function() {
        this.addEventListener('userUpdated', function() {
          this.set('user', COOK.User);
        }.bind(this));
        ga('send', {
          hitType: 'timing',
          timingCategory: 'shell',
          timingVar: 'ready',
          timingValue: window.performance.now(),
        });
        this.loadDate = new Date();
      },
      _routePageChanged: function(page) {
        this.page = page || 'kitchen';
      },
      _routePathChanged: function(path) {
        // if it's been 2 days since page loaded, reload.
        if (this.loadDate && (new Date() - this.loadDate) > 2 * 86400 * 1000) {
          window.location = path;
        }
      },
      _pageChanged: function(page) {
        if (this.user !== undefined && this.user !== null && !this.user.isOnboard && page !== 'onboard') {
          this.setPath('onboard');
          return;
        }
        if (this.user.isOnboard && page === 'onboard' && !COOK.isDev) {
          this.setPath('kitchen');
          return;
        }
        var hideHeaderLogo = false;
        // Load page import on demand. Show 404 page if fails
        var resolvedPageURL, element, title;
        switch (page) {
          case 'onboard':
            resolvedPageURL = this.resolveUrl('onboard-steps.html');
            element = this.$.onboard;
            title = 'Onboard';
            break;
          case 'kitchen':
            resolvedPageURL = this.resolveUrl('kitchen-page.html');
            element = this.$.kitchen;
            title = 'Kitchen';
            hideHeaderLogo = true;
            break;
          case 'inquiries':
            resolvedPageURL = this.resolveUrl('inquiries-page.html');
            element = this.$.inquiries;
            title = 'Inquiries';
            hideHeaderLogo = true;
            break;
          case 'messages':
            resolvedPageURL = this.resolveUrl('messages-page.html');
            element = this.$.messages;
            title = 'Messages';
            hideHeaderLogo = true;
            break;
          case 'account':
            resolvedPageURL = this.resolveUrl('account-page.html');
            element = this.$.account;
            title = 'Account';
            hideHeaderLogo = true;
            break;
          default:
            resolvedPageURL = this.resolveUrl('my-' + page + '.html');
        }
        this.importHref(resolvedPageURL, function() {
          try {
            this.set('title', title);
            this.set('hideHeaderLogo', hideHeaderLogo);
            element.selected();
          } catch (err) {
            console.error(err);
          }
        }.bind(this), this._showPage404, true);
      },
      _pageOrScreenChanged: function(page, smallScreen) {
        // var backPage = (page === 'edititem' || page === 'postitem'
        //   || page === 'updateprofile' || page === 'updatepayout');
        // this.$.arrowBack.toggleClass('hide', !backPage);
        // this.$.menuIcon.toggleClass('hide', (!smallScreen || backPage));
        // if (smallScreen || backPage) {
        //   this.$.toolbarRight.className += ' hide';
        // } else {
        //   this.$.toolbarRight.className = this.$.toolbarRight.className.replace(/hide/g, '');
        // }
      },
      titleUpdated: function(title) {
        document.title = title + ' - Cook | Gigamunch';
      },
      _showPage404: function() {
        this.page = 'view404';
        this.title = 'Page not found';
      },
      setPath: function(path) {
        var route = '/';
        if (path !== undefined) {
          route += path;
        }
        this.set('route.path', this.baseurl + route);
        this.page = path;
      },
      toastEvent: function(e, detail) {
        var text = detail.text;
        if (text && text !== "") {
          var duration = detail.duration || 3000;
          this.$.toast.show({
            text: text,
            duration: duration
          });
        }
      },
      errorEvent: function(e, error) {
        var text;
        var details;
        switch (typeof(error)) {
          case 'object':
            if (typeof(error) === 'string') {
              text = error;
            } else {
              text = error.message;
              if (error.detail !== undefined && error.detail !== '') {
                details += error.detail;
              }
            }
            break;
          default:
            text = error.toString();
        }
        if (error.notification === true || (error !== undefined && error.code !== undefined && error.code === 400)) {
          this.$.notificationDialogText.innerHTML = text;
          this.$.notificationDialog.open();
        } else {
          if (details !== '') {
            this.$.errorDialogDetails.innerHTML = 'Detailed gibberish:' + details;
          }
          this.$.errorDialogText.innerHTML = text;
          this.$.errorDialog.open();
        }
      },
    });

  </script>
</dom-module>
