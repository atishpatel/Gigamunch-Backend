<link rel="import"
      href="../bower_components/polymer/polymer.html">
<link rel="import"
      href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import"
      href="../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import"
      href="shared-styles.html">
<link rel="import"
      href="message-card.html">

<dom-module id="channel-page">
  <template>
    <style include="shared-styles">
       :host {
        display: flex;
        flex-direction: column;
        background-color: white;
        max-width: var(--max-content-width);
        margin: auto;
      }
      
      #spinner {
        display: flex;
        margin: auto;
        padding: 50px;
      }
      
      .messages {
        padding: 0 12px;
        min-height: 20vh;
        max-height: 80vh;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
        flex-direction: column;
        padding-bottom: 12px;
        margin-bottom: 48px;
      }
      
      .send-container {
        position: fixed;
        bottom: 0px;
        display: flex;
        flex-direction: row;
        padding: 2px;
        width: 99%;
      }
      
      .send-input {
        flex: 1;
        border: none;
        background-color: white;
        --iron-autogrow-textarea: {
          outline: none;
          padding: 12px;
          border: solid var(--gray-line-color) 1px;
          border-right: none;
          border-top-left-radius: 3px;
          border-bottom-left-radius: 3px;
          font-size: 14px;
          background-color: #f7f7f7;
        }
      }
      
      .send-input:focus {
        background-color: white;
      }
      
      .send-button {
        background-color: white;
        color: var(--primary-text-color);
        text-decoration: none;
        margin: 0;
        border: solid var(--gray-line-color) 1px;
        border-left: none;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
      }
      
      @media (min-width: 1000px) {
        .send-container {
          width: 1000px;
        }
      }

    </style>
    <paper-spinner id="spinner"
                   hidden$="[[!showSpinner]]"
                   active="[[showSpinner]]">
    </paper-spinner>

    <div id="messages"
         class="messages">
      <template is="dom-repeat"
                items="[[messages]]"
                as="message">
        <message-card message="[[message]]"
                      eaterid="[[eaterID]]"
                      eaterimage="[[eaterImage]]"
                      cookid="[[cookID]]"
                      cookimage="[[cookImage]]"
                      on-getinquiry="getInquiry">
        </message-card>
      </template>
    </div>
    <div id="bottomMessages"></div>
    <div class="send-container">
      <iron-autogrow-textarea disabled="[[sendMessageDisabled]]"
                              class="send-input"
                              placeholder="Type a message"
                              bind-value="{{sendMessageText}}">
      </iron-autogrow-textarea>
      <paper-button class="send-button"
                    on-tap="sendMessage">
        Send
      </paper-button>
    </div>
  </template>

  <script>
    Polymer({
      is: 'channel-page',
      properties: {
        channelSID: {
          type: String,
          value: '',
        },
        messages: {
          type: Array,
          notify: true,
        },
        title: {
          type: String,
          notify: true,
          reflectToAttribute: true,
        },
        eaterID: {
          type: String,
        },
        eaterImage: {
          type: String,
        },
        cookID: {
          type: String,
        },
        cookImage: {
          type: String,
        },
        showSpinner: {
          type: Boolean,
        },
        sendMessageText: {
          type: String,
          notify: true,
        },
        sendMessageDisabled: {
          type: Boolean,
          value: false,
        },
        channelId: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          observer: 'channelIdChanged',
          value: '',
        }
      },
      selected: function() {
        ga('send', 'event', 'page', 'channel');
        this.title = '';
        this.messages = [];
        this.channelIdChanged();
      },
      channelIdChanged: function() {
        if (window.location.pathname.includes('/channel/')) {
          var tmp = window.location.pathname.split('/channel/');
          var id = decodeURIComponent(tmp[1]);
          this.channelId = id;
        }
        if (this.channelId !== undefined && this.channelId !== null && this.channelId !== '' && this.channelId !== 'channel') {
          this.getChannel();
        }
      },
      ready: function() {
        window.addEventListener('messageAdded', this.getMessages.bind(this));
      },
      getChannel: function() {
        this.showSpinner = true;
        var id = this.channelId;
        if (window.messagingClient && id !== undefined && id !== null && id.length > 2 && id !== 'channel') {
          window.messagingClient.getChannelByUniqueName(id).then(function(channel) {
            if (channel === null) {
              this.fire('toast', {
                text: 'Messaging channel not found. Redirecting to the Messages page.',
                duration: 6000,
              });
              // window.location = 'channels';
              return;
            }
            this.channelSID = channel.sid;
            // get attributes
            this.getAttributes();
            // get messages
            this.getMessages();
          }.bind(this)).catch(function(resp) {
            console.error('failed to get twilio messages:', resp);
            ga('send', 'exception', {
              exDescription: resp,
              exFatal: true,
            });
            this.fire('toast', {
              text: 'Failed to get messages. Try again in a few minutes.'
            });
          }.bind(this));
        } else {
          setTimeout(this.getChannel.bind(this), 100);
        }
      },
      getAttributes: function() {
        var channelSID = this.channelSID;
        window.messagingClient.channels.get(channelSID).getAttributes().then(function(attr) {
          this.eaterImage = attr.eater_image;
          // this.eaterName = attr.eater_name;
          this.eaterID = attr.eater_id;
          this.cookImage = attr.cook_image;
          // this.cookName = attr.cook_name;
          this.cookID = attr.cook_id;
          this.title = attr.eater_name;
        }.bind(this));
      },
      getMessages: function() {
        var channelSID = this.channelSID;
        window.messagingClient.channels.get(channelSID).getMessages(100).then(function(messages) {
          var previousAuthor = '';
          for (var i = messages.length - 1; i >= 0; i--) {
            messages[i].isPreviousAuthorSame = false;
            if (!messages[i].author.includes('Bot') && previousAuthor === messages[i].author) {
              messages[i].isPreviousAuthorSame = true;
            }
            previousAuthor = messages[i].author;
          }
          this.messages = messages;
          this.showSpinner = false;
          this.async(function() {
            this.$.messages.scrollTop = this.$.messages.scrollHeight;
          }.bind(this), 300);
          this.async(function() {
            this.$.messages.scrollTop = this.$.messages.scrollHeight;
          }.bind(this), 600);
          this.async(function() {
            this.$.messages.scrollTop = this.$.messages.scrollHeight;
          }.bind(this), 1000);
        }.bind(this));
      },
      getInquiry: function(e) {
        var id = e.detail.id;
        var callback = e.detail.callback;
        COOK.Service.getInquiry(id, callback);
      },
      sendMessage: function() {
        if (this.sendMessageText === undefined || this.sendMessageText === '' || this.sendMessageDisabled) {
          return;
        }
        var channelSID = this.channelSID;
        if (channelSID !== undefined && channelSID !== null && channelSID !== '') {
          this.sendMessageDisabled = true;
          var message = this.sendMessageText;
          var successCallback = function(messageID) {
            this.sendMessageText = '';
            this.sendMessageDisabled = false;
            this.getMessages()
          }.bind(this);
          var failureCallback = function(resp) {
            console.error('failed to send twilio message:', resp);
            ga('send', 'exception', {
              exDescription: resp,
              exFatal: true,
            });
            this.fire('toast', {
              text: 'Failed to send message. Try again in a few minutes.'
            });
            this.sendMessageDisabled = false;
          }.bind(this);
          // prevents bug with channel being passed in not being able to send
          window.messagingClient.channels.get(channelSID).sendMessage(message).then(successCallback).catch(failureCallback);
        } else {
          setTimeout(this.sendMessage.bind(this), 100);
        }
      },
    });

  </script>
</dom-module>
