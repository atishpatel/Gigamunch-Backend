<link rel="import"
      href="../bower_components/polymer/polymer.html">
<link rel="import"
      href="../bower_components/google-apis/google-maps-api.html">
<link rel="import"
      href="../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import"
      href="../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">

<link rel="import"
      href="app-input.html">

<dom-module id="address-input">
  <template>
    <style include="app-input">
       :host {
        display: block;
      }
      
      .row {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
      }
      
      .row>*:not(:first-child) {
        margin-left: 8px;
      }
      
      .flex-1 {
        flex: 1;
      }
      
      .flex-2 {
        flex: 2;
      }
      
      .flex-3 {
        flex: 3;
      }
      
      label {
        line-height: 20px;
      }
      
      paper-progress {
        width: 100%;
        padding-top: 20px;
      }

    </style>
    <google-maps-api id="mapsapi"
                     api-key="AIzaSyCDOw6QXpThS7dm3rl79wDdEvwPlLWsi0Y"
                     on-api-load="mapsLoaded">
    </google-maps-api>
    <div class="row">
      <app-input class="flex-1">
        <input id="aptInput"
               placeholder="Apt #"
               value="{{address.apt::change}}">
        <app-md-decorator aria-hidden="true">
          <label>Apt #</label>
          <app-underline></app-underline>
        </app-md-decorator>
      </app-input>
      <app-input class="flex-3">
        <input id="addressInput"
               placeholder="Enter Address*"
               required>
        <app-md-decorator error-message="Invalid Address"
                          aria-hidden="true">
          <label>Enter Address</label>
          <app-underline></app-underline>
        </app-md-decorator>
      </app-input>
    </div>

  </template>
  <script>
    'use strict';

    Polymer({
      is: 'address-input',

      properties: {
        address: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          observer: 'addressChanged',
        },
        autocomplete: {
          type: Object,
        },
        invalid: {
          type: Boolean,
          notify: true,
        },
      },
      behaviors: [
        Polymer.IronFormElementBehavior,
        Polymer.IronValidatableBehavior
      ],
      selected: function() {

      },
      mapsLoaded: function() {
        var addressInput = this.$.addressInput;
        this.autocomplete = new this.$.mapsapi.api.places.Autocomplete(addressInput, {
          types: ['address']
        });
        this.autocomplete.addListener('place_changed', this.autocompleteSelected.bind(this));
      },
      autocompleteSelected: function() {
        var componentForm = {
          street_number: 'short_name',
          route: 'long_name',
          locality: 'long_name',
          administrative_area_level_1: 'short_name',
          country: 'long_name',
          postal_code: 'short_name'
        };
        // Get the place details from the autocomplete object.
        var place = this.autocomplete.getPlace();

        for (var component in componentForm) {
          // document.getElementById(component).value = '';
        }
        var address = {};
        // Get each component of the address from the place details
        // and fill the corresponding field on the form.
        for (var i = 0; i < place.address_components.length; i++) {
          var addressType = place.address_components[i].types[0];
          if (componentForm[addressType]) {
            var val = place.address_components[i][componentForm[addressType]];
            address[addressType] = val;
          }
        }
        var apt = '';
        if (this.address.apt) {
          apt = this.address.apt.toUpperCase();
        }
        var street = address['street_number'] + ' ' + address['route'];
        var city = address['locality'];
        var state = address['administrative_area_level_1'];
        var country = address['country'];
        var zip = address['postal_code'];
        var latitude = place.geometry.location.lat().toFixed(7);
        var longitude = place.geometry.location.lng().toFixed(7);
        this.set('address', {
          apt: apt,
          street: street,
          city: city,
          state: state,
          zip: zip,
          country: country,
          latitude: latitude,
          longitude: longitude,
        });
      },
      addressChanged: function() {
        // set input fields if they aren't updated
        if (this.address !== undefined && this.address.street !== undefined && this.address.street !== "") {
          var str = this.address.street + ', ' + this.address.city + ', ' + this.address.state + ', ' + this.address.country;
          if (this.$.addressInput.value !== str) {
            this.$.addressInput.value = str;
            this.$.aptInput.value = this.address.apt;
          }
        }
      },
      _getValidity: function() {
        var valid = this.address !== undefined && this.address.street !== undefined && this.address.street !== "";
        if (!valid) {
          this.$.addressInput.setAttribute('invalid', true);
          this.$.addressInput.setAttribute('aria-invalid', true);
        } else {
          this.$.addressInput.setAttribute('invalid', false);
          this.$.addressInput.setAttribute('aria-invalid', false);
        }
        return valid
      },
    });

  </script>
</dom-module>
