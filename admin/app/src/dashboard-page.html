<link rel="import"
      href="../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import"
      href="shared-styles.html">
<link rel="import"
      href="materialize-styles.html">

<link rel="import"
      href="cohort-table.html">

<dom-module id="dashboard-page">
  <template>
    <shared-styles>
      <style include="materialize-styles shared-styles">
        :host {
          display: block;
          padding: 12px;
        }

        .chart {
          height: 500px;
          padding: 12px;
        }

        .table {
          display: table;
          width: 100%;
          border: 1px solid #000;
        }

        .table-header-row {
          background-color: #ccc;
          display: table-header-group;
          font-weight: bold;
        }

        .table-row {
          display: table-row;
          width: auto;
          clear: both;
        }

        .table-cell {
          border: 1px solid #999999;
          padding: 3px 10px;
          display: table-cell;
          flex: 1;
          /*display: flex;*/
          justify-content: space-between;
          align-items: center;
        }

        .table-body {
          display: table-row-group;
        }

      </style>
    </shared-styles>

    <div>
      <h1 class="page-title">Dashboard</h1>
      <paper-spinner hidden$="[[!loading]]"
                     active="[[loading]]">
      </paper-spinner>
      <input id="date"
             type="date"
             style="max-width:300px">
      <br>
      <paper-button on-tap="getDashboardStats">Get Cohorts After Date</paper-button>
      <h2>Monthly</h2>
      <div id="monthlyAvgChart"
           class="chart"></div>
      <cohort-table cohort="[[monthlyCohort]]"></cohort-table>
      <h2>Weekly</h2>
      <p>How long people are with us based on week. This doesn't account for skip at all.</p>
      <div id="weeklyAvgChart"
           class="chart"></div>
      <cohort-table cohort="[[weeklyCohort]]"></cohort-table>
      <h2>Weekly Paid</h2>
      <p>This is an imprefect cohort that basically says. The person did not skip from the day they started the service for the same number of times they have recieved Gigamunch in total.</p>
      <div id="weeklyPaidAvgChart"
           class="chart"></div>
      <cohort-table cohort="[[weeklyPaidCohort]]"></cohort-table>

      <h2>Subscriber Summary</h2>
      <div class="table-container">
        <div class="table">
          <div class="table-row table-header-row">
            <div class="table-cell">Email</div>
            <div class="table-cell">Subscriber</div>
            <div class="table-cell">First Date</div>
            <div class="table-cell">Last Date</div>
            <div class="table-cell">Num Skips</div>
            <div class="table-cell">Num Paid</div>
            <div class="table-cell">Num Total</div>
            <div class="table-cell">Num Refunded</div>
            <div class="table-cell">Total Amount Paid</div>
            <div class="table-cell">Total Amount</div>
            <div class="table-cell">Skip Percent</div>
          </div>
          <dom-repeat items="[[subs]]"
                      as="sub">
            <template>
              <div class="table-row">
                <div class="table-cell">
                  <a target="_blank"
                       href="subscriber/[[sub.email]]">[[sub.email]]</a>
                </div>
                <div class="table-cell">[[sub.is_subscriber]]</div>
                <div class="table-cell">[[sub.min_date_string]]</div>
                <div class="table-cell">[[sub.max_date_string]]</div>
                <div class="table-cell">[[sub.num_skip]]</div>
                <div class="table-cell">[[sub.num_paid]]</div>
                <div class="table-cell">[[sub.num_total]]</div>
                <div class="table-cell">[[sub.num_refunded]]</div>
                <div class="table-cell">[[sub.total_amount_paid_string]]</div>
                <div class="table-cell">[[sub.total_amount_string]]</div>
                <div class="table-cell">[[sub.skip_percent]]</div>
            </template>
          </dom-repeat>
        </div>
      </div>
    </div>
  </template>

  <script>
    class DashboardPage extends Polymer.Element {
      static get is() {
        return 'dashboard-page';
      }

      static get properties() {
        return {
          serviceold: {
            type: Object,
          },
          subs: {
            type: Object,
          },
          weeklyCohort: {
            type: Object,
            notify: true,
          },
          weeklyPaidCohort: {
            type: Object,
            notify: true,
          },
          monthlyCohort: {
            type: Object,
            notify: true,
          }
        }
      }

      static get observers() {
        return [ /* observer descriptors */ ]
      }

      selected() {
        this.getDashboardStats();
      }

      getDashboardStats() {
        this.loading = true;
        const dateValue = this.$.date.value;
        let date = new Date('0001-01-01');
        if (dateValue) {
          date = new Date(dateValue);
        }
        this.serviceold.GetGeneralStats(date, (resp) => {
          this.loading = false;
          const err = resp.err;
          if (err && err.code !== 0) {
            return;
          }

          let lastSunday = this._getLastSunday();
          let subs = resp.activities;
          subs.sort(function(a, b) {
            if (a.max_date === b.max_date) {
              return a.min_date.localeCompare(b.min_date);
            }
            return a.max_date.localeCompare(b.max_date);
          });
          for (let i = 0; i < subs.length; i++) {

            subs[i].is_subscriber = true;
            let d = new Date(subs[i].max_date);
            if (d < lastSunday) {
              subs[i].is_subscriber = false;
            }
            let skipPercent = (subs[i].num_skip / subs[i].num_total) * 100;
            if (skipPercent) {
              subs[i].skip_percent = skipPercent.toFixed(2) + '%';
            }
            subs[i].min_date_string = this._getDate(subs[i].min_date);
            subs[i].max_date_string = this._getDate(subs[i].max_date);
            subs[i].total_amount_paid_string = this._getMoney(subs[i].total_amount_paid);
            subs[i].total_amount_string = this._getMoney(subs[i].total_amount);
          }
          this.subs = subs;

          this.weeklyCohort = resp.weekly_cohort_analysis;
          this.weeklyPaidCohort = resp.weekly_paid_cohort_analysis;
          this.monthlyCohort = resp.monthly_cohort_analysis;
          this._drawCohortChart(this.monthlyCohort, this.$.monthlyAvgChart);
          this._drawCohortChart(this.weeklyCohort, this.$.weeklyAvgChart);
          this._drawCohortChart(this.weeklyPaidCohort, this.$.weeklyPaidAvgChart);
        });
      }

      _getLastSunday() {
        let d = new Date();
        while (d.getDay() !== 0) {
          d.setTime(d.getTime() - 24 * 3600 * 1000); // last day
        }
        d = new Date(d.toLocaleDateString() + ' 12:00:00');
        return d;
      }

      _getDate(date) {
        return date.substr(0, 10)
      }

      _getMoney(num) {
        if (!num) {
          return '-'
        }
        return '$' + num.toFixed(2);
      }

      _drawCohortChart(cohort, element) {
        var dataArray = [
          ['Week', 'Retention']
        ];
        for (let i = 0; i < cohort.average_retention.length; i++) {
          const point = [i, cohort.average_retention[i]];
          dataArray.push(point)
        }
        var data = google.visualization.arrayToDataTable(dataArray);

        var options = {
          title: 'Average Retention',
        };

        var chart = new google.visualization.LineChart(element);

        chart.draw(data, options);
      }

    }
    window.customElements.define(DashboardPage.is, DashboardPage);

  </script>
</dom-module>
