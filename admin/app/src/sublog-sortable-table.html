<link rel="import"
      href="../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../bower_components/iron-icon/iron-icon.html">
<link rel="import"
      href="../bower_components/paper-styles/color.html">
<link rel="import"
      href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import"
      href="shared-styles.html">
<link rel="import"
      href="materialize-styles.html">
<link rel="import"
      href="app-icons.html">

<dom-module id="sublog-sortable-table">
  <template>
    <shared-styles>
      <style include="materialize-styles shared-styles">
        :host {
          display: block;
        }

        .sublog-table {
          padding: 12px;
          box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
          border: 1px solid rgba(0, 0, 0, .12);
        }

        .details {
          padding: 24px 0;
        }

      </style>
    </shared-styles>
    <div class="details">
      <div><strong>With extra:</strong></div>
      <div>Total Non Veg servings: <strong>[[totalNoVegServingsExtra]]</strong></div>
      <div>Total Veg servings: <strong>[[totalVegServingsExtra]]</strong></div>
      <div>Total Non Veg containers: <strong>[[totalNoVegContainersExtra]]</strong></div>
      <div>Total Veg conatiners: <strong>[[totalVegContainersExtra]]</strong></div>

      <br>
      <br>
      <div>Total Non Veg servings: <strong>[[totalNoVegServings]]</strong></div>
      <div>Total Veg servings: <strong>[[totalVegServings]]</strong></div>
      <div>Total Non Veg containers: <strong>[[totalNoVegContainers]]</strong></div>
      <div>Total Veg conatiners: <strong>[[totalVegContainers]]</strong></div>
      <br>
      <div>Number of Customers: <strong>[[numCustomers]]</strong></div>
      <div>Number of 2 Serving Customers: <strong>[[num2Customers]]</strong></div>
      <div>Number of 4 Serving Customers: <strong>[[num4Customers]]</strong></div>
      <div>Number of 4+ Serving Customers: <strong>[[num4PlusCustomers]]</strong></div>
      <br>
      <div>Predicted Revenue: <strong>$[[predictedRevenue]]</strong></div>
      <div>Total Revenue: <strong>$[[totalRevenue]]</strong></div>
      <div>Total Tax: <strong>$[[totalTax]]</strong></div>
      <div>Total Processing Cost: <strong>$[[totalProcessingCost]]</strong></div>
      <div>Total Free + Discount Cost: <strong>$[[totalCost]]</strong></div>
      <br>
      <div>Percent skip: <strong>[[percentSkip]] %</strong></div>
    </div>
    <paper-checkbox checked="{{detailed}}"
                    style="margin: 20px 0px">Transactions Mode</paper-checkbox>
    <div class="table-container">
      <table class="striped sublog-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th hidden="[[detailed]]">Servings</th>
            <th hidden="[[detailed]]">Veg Servings</th>
            <th hidden="[[detailed]]">Status</th>
            <th hidden="[[detailed]]">Address</th>
            <th hidden="[[detailed]]">Phone #</th>
            <th hidden="[[detailed]]">Delivery Tip</th>
            <th hidden$="[[!detailed]]">Transaction ID</th>
            <th hidden$="[[!detailed]]">Customer ID</th>
            <th hidden$="[[!detailed]]">Refunded</th>
            <th hidden$="[[!detailed]]">Discount <br>Amount | Percent</th>
            <th hidden$="[[!detailed]]">Amount</th>
            <th hidden$="[[!detailed]]">Amount Paid</th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat"
                    items="[[sublogs]]"
                    as="sublog">
            <tr>
              <td>[[sublog.name]]</td>
              <td>[[sublog.sub_email]]</td>
              <td hidden="[[detailed]]">[[sublog.servings]]</td>
              <td hidden="[[detailed]]">[[sublog.vegetarian_servings]]</td>
              <td hidden="[[detailed]]">[[sublog.status]]</td>
              <td hidden="[[detailed]]">
                <a target="_blank"
                   href="[[sublog.addressLink]]">[[sublog.addressString]]</a>
              </td>
              <td hidden="[[detailed]]">[[sublog.phone_number]]</td>
              <td hidden="[[detailed]]">[[sublog.delivery_tip]]</td>
              <td hidden$="[[!detailed]]">[[sublog.transaction_id]]</td>
              <td hidden$="[[!detailed]]">
                <a target="_blank"
                   href="https://www.braintreegateway.com/merchants/wsgmypp8c46cnbpc/customers/[[sublog.customer_id]]">[[sublog.customer_id]]</a>
              </td>
              <td hidden$="[[!detailed]]">[[sublog.refunded]]</td>
              <td hidden$="[[!detailed]]">$[[sublog.discount_amount]] | [[sublog.discount_percent]]%</td>
              <td hidden$="[[!detailed]]">[[sublog.amount]]</td>
              <td hidden$="[[!detailed]]">[[sublog.amount_paid]]</td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

  </template>

  <script>
    class SublogSortableTable extends Polymer.Element {
      static get is() {
        return 'sublog-sortable-table';
      }

      static get properties() {
        return {
          sublogs: {
            type: Array,
            notify: true,
            observer: 'sublogsObserver',
          },
          totalNoVegServings: {
            type: Number,
            notify: true,
          },
          totalVegServings: {
            type: Number,
            notify: true,
          },
          totalNoVegContainers: {
            type: Number,
            notify: true,
          },
          totalVegContainers: {
            type: Number,
            notify: true,
          },
          numCustomers: {
            type: Number,
          },
          num2Customers: {
            type: Number,
          },
          num4Customers: {
            type: Number,
          },
          num4PlusCustomers: {
            type: Number,
          },
          predictedRevenue: {
            type: String,
            notify: true,
          },
          totalRevenue: {
            type: String,
            notify: true,
          },
          totalCost: {
            type: String,
            notify: true,
          },
          totalTax: {
            type: String,
            notify: true,
          },
          totalProcessingCost: {
            type: String,
            notify: true,
          },
          detailed: {
            type: Boolean,
            notify: true,
            value: false,
          }
        }
      }

      static get observers() {
        return [ /* observer descriptors */ ]
      }
      constructor() {
        super();
      }
      connectedCallback() {
        super.connectedCallback();
      }

      getStatus(sublog) {
        if (sublog.refunded) {
          return 'Refunded';
        } else if (sublog.free) {
          return 'Free';
        } else if (sublog.paid) {
          return 'Paid';
        } else if (sublog.skip) {
          return 'Skipped';
        }
        return 'Unpaid';
      }

      getAddress(a) {
        if (a && a.street) {
          let apt = '';
          if (a.apt !== undefined && a.apt !== '') {
            apt = '#' + a.apt + ' ';
          }
          return apt + a.street + ', ' + a.city;
        }
        return '';
      }

      getAddressLink(a) {
        if (a && a.street) {
          return 'https://maps.google.com/?q=' + encodeURIComponent(a.apt + ' ' + a.street + ', ' + a.city + ', ' + a.state + ' ' + a.zip);
        }
        return '';
      }

      sublogsObserver() {
        if (this.sublogs) {
          const sublogs = this.sublogs;
          let numCustomers = 0;
          let num2Customers = 0;
          let num4Customers = 0;
          let num4PlusCustomers = 0;
          let totalNoVegServings = 0;
          let totalVegServings = 0;
          let predictedRevenue = 0.0;
          let totalRevenue = 0.0;
          let totalCost = 0.0;
          let totalTax = 0.0;
          let totalProcessingCost = 0.0;
          for (var i = 0; i < sublogs.length; i++) {
            totalNoVegServings += sublogs[i].servings;
            totalVegServings += sublogs[i].vegetarian_servings;
            sublogs[i].status = this.getStatus(sublogs[i]);
            sublogs[i].addressString = this.getAddress(sublogs[i].address);
            sublogs[i].addressLink = this.getAddressLink(sublogs[i].address);
            // calculate revenue
            if (sublogs[i].free) {
              totalCost += sublogs[i].amount;
            } else {
              predictedRevenue += sublogs[i].amount;
            }
            if (sublogs[i].paid) {
              totalCost += sublogs[i].amount_paid - sublogs[i].amount;
            }
            totalRevenue += sublogs[i].amount_paid;
            // calculate number customers
            numCustomers++;
            if (sublogs[i].servings === 2 || sublogs[i].vegetarian_servings === 2) {
              num2Customers++;
            } else if (sublogs[i].servings === 4 || sublogs[i].vegetarian_servings === 4) {
              num4Customers++;
            } else {
              num4PlusCustomers++;
            }
            totalTax += sublogs[i].amount_paid * .0975;
            totalProcessingCost += sublogs[i].amount_paid * .029 + .3;
          }
          this.sublogs = sublogs;
          this.totalNoVegServings = totalNoVegServings;
          this.totalVegServings = totalVegServings;
          this.totalNoVegContainers = totalNoVegServings / 2;
          this.totalVegContainers = totalVegServings / 2;
          this.totalNoVegServingsExtra = totalNoVegServings + 6;
          this.totalVegServingsExtra = totalVegServings + 2;
          this.totalNoVegContainersExtra = this.totalNoVegServingsExtra / 2;
          this.totalVegContainersExtra = this.totalVegServingsExtra / 2;
          this.predictedRevenue = predictedRevenue.toFixed(2);
          this.totalRevenue = totalRevenue.toFixed(2);
          this.totalCost = totalCost.toFixed(2);
          this.numCustomers = numCustomers;
          this.num2Customers = num2Customers;
          this.num4Customers = num4Customers;
          this.num4PlusCustomers = num4PlusCustomers;
          this.totalTax = totalTax.toFixed(2);
          this.totalProcessingCost = totalProcessingCost.toFixed(2);
        }
      }

    }

    customElements.define(SublogSortableTable.is, SublogSortableTable);

  </script>
</dom-module>
